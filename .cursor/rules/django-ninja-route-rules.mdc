---
description: Django Ninja 路由與端點規則（本專案）
globs: "studies/*_api.py"
priority: critical
category: django-ninja-routes
alwaysApply: true
dependencies: ["django-application-rules.mdc", "django-error-handling-rules.mdc", "pagination-rules.mdc"]
---

# Django Ninja 路由規則

## 基本
- 僅使用 `from ninja import Router, Query` 與 `@router.get/post/...`
- 回應類型必須以 Pydantic 模型（或 `List[Model]`）註記，確保合約穩定
- Datetime 一律使用 `ISO 8601` 字串（`dt.isoformat()`）

## 分頁
- `studies`：`@paginate(StudyPagination)`，回傳 `items/count/filters`
- `reports`：`@paginate(ReportPagination)`，統一 `page/page_size`，回傳 `items/total/page/page_size/pages`
- `projects`：`@paginate(ProjectPagination)`，回傳 `items/count`
- 端點需支援 `page/page_size`；必要時兼容舊 `limit/offset`（僅過渡）

## 參數處理
- 陣列查詢參數需同時支援 `param[]=a&param[]=b` 與重複鍵 `param=a&param=b`
- 排序參數需白名單校驗（例如 Projects 的 `ALLOWED_SORT_FIELDS`）

## 例外轉換
- Service 層拋出 `studies.exceptions` 中的領域錯誤
- API 層：
  - `StudyNotFoundError` → `Http404`
  - 驗證/參數錯誤 → `HttpError(422/400)`
  - 其餘交由 Ninja 統一處理（並記錄）

## 專案與權限
- Projects 路由需使用 `JWTAuth()` 與 `studies.permissions` 的 decorator（`@require_view` 等）
- 路由內僅進行輸入/授權/回應整形，業務邏輯放入對應 Service

## 過時端點
- `/reports/search` 僅為相容用途，必須記錄 deprecation 警告並限制 `limit<=500`，新端點一律使用 `/reports/search/paginated`
