---
description: Django 後端效能最佳化規則（本專案）
globs: "**/*.py"
priority: high
category: performance
alwaysApply: true
dependencies: ["django-database-interaction-rules.mdc"]
---

# 效能最佳化規則（Django）

## 查詢最佳化
- 嚴禁 N+1：使用 `select_related()/prefetch_related()`
- 大清單查詢必須分頁；`page_size` 預設 20、最大 100（自動夾限）
- 在 Service 層實施 DB 端 `LIMIT/OFFSET`，避免全量載入後切片
- 原生 SQL 必須參數化並盡量共用 WHERE 條件以利 Planner 利用索引

## 快取策略
- 使用 Django Cache（開發 `locmem`，生產 `redis`）
- Key 需含版本前綴，TTL 依資料變動頻率（如 filters 24h）
- 快取失敗僅記錄警告，不影響主流程（降級運行）

## 回應大小與序列化
- 僅傳必要欄位；大欄位提供 preview（如 `content_preview` 500 chars）
- Datetime 以 `isoformat()` 字串傳回

## 量測
- 使用 `RequestTimingMiddleware` 記錄請求耗時
- 報表搜尋（page_size=10/100）需維持 <100ms / <300ms 的目標
