---
description: Linus é¢¨æ ¼çš„å¯¦ç”¨ä¸»ç¾©ç¨‹å¼ç¢¼å“è³ªè¦å‰‡ï¼ˆDjango å¾Œç«¯ï¼‰
globs: "**/*.py"
priority: high
category: code-quality
alwaysApply: true
---

# Linus é¢¨æ ¼ç¨‹å¼ç¢¼å“è³ªï¼ˆç²¾è¦ï¼‰

## æª¢æŸ¥æ¸…å–®
1. ç¸®æ’ä¸è¶…é 3 å±¤ï¼›è¶…éå°±é‡æ§‹ï¼ˆEarly return / æ‹†å‡½æ•¸ï¼‰
2. if/else éˆä¸è¶…é 3 æ®µï¼›ç”¨è³‡æ–™çµæ§‹å–ä»£åˆ†æ”¯
3. å‡½æ•¸éé•·ï¼ˆ>20 è¡Œï¼‰è€ƒæ…®æ‹†åˆ†ï¼›åç¨±å¿…é ˆæ¸…æ™°å¯è®€
4. åˆ¥è§£æ±ºä¸å­˜åœ¨çš„å•é¡Œï¼šæ‹’çµ•éåº¦æŠ½è±¡èˆ‡ç„¡ç”¨å·¥å» 
5. è³‡æ–™çµæ§‹é©…å‹•è¨­è¨ˆï¼›æ¶ˆé™¤ç‰¹æ®Šæƒ…æ³

## åæ¨¡å¼ï¼ˆæ‹’æ”¶ï¼‰
- æ·±åº¦å·¢ç‹€ã€é­”è¡“æ•¸å­—ã€å«ç³Šå‘½å
- æ•ç²æ‰€æœ‰ä¾‹å¤–å»ä¸è™•ç†æˆ–éš±è—
- åœ¨è·¯ç”±å±¤å¯«è¤‡é›œé‚è¼¯ï¼ˆæ‡‰ç§»è‡³ Serviceï¼‰

---
description: Linus Torvalds é¢¨æ ¼çš„ç¨‹å¼ç¢¼å¯©æŸ¥æ¨™æº–ï¼Œå¼·èª¿ Good Tasteã€ç°¡æ½”æ€§å’Œå¯¦ç”¨ä¸»ç¾©
globs: "**/*.py"
priority: critical
category: code-quality
alwaysApply: true
dependencies: ["medical-imaging-python.mdc", "python-general-principles.mdc"]
---

# Linus é¢¨æ ¼ç¨‹å¼ç¢¼å¯©æŸ¥æ¨™æº–

## Good Taste è©•åˆ¤æ¨™æº–

### ğŸŸ¢ Good Taste ç¨‹å¼ç¢¼ç‰¹å¾µ
```python
# âœ… æ¶ˆé™¤ç‰¹æ®Šæƒ…æ³ - ç”¨è³‡æ–™çµæ§‹è§£æ±ºå•é¡Œ
SEQUENCE_PROCESSORS = {
    'T1': process_t1,
    'T2': process_t2, 
    'DWI': process_dwi,
}

def process_sequence(sequence_type: str, data: DicomData) -> Result:
    """Good Taste: ç„¡ if/else éˆï¼Œç„¡ç‰¹æ®Šæƒ…æ³"""
    processor = SEQUENCE_PROCESSORS.get(sequence_type, process_default)
    return processor(data)

# âœ… è³‡æ–™çµæ§‹é©…å‹•ï¼Œè€Œéé‚è¼¯é©…å‹•
class ProcessingResult:
    """ç°¡æ½”çš„è³‡æ–™çµæ§‹ï¼Œè‡ªèªªæ˜"""
    success: bool
    data: Optional[ProcessedData]
    error: Optional[str]
    
    @classmethod
    def ok(cls, data: ProcessedData) -> 'ProcessingResult':
        return cls(True, data, None)
    
    @classmethod  
    def error(cls, msg: str) -> 'ProcessingResult':
        return cls(False, None, msg)

# âœ… Early returnï¼Œæ‰å¹³çµæ§‹
def validate_dicom(path: Path) -> ValidationResult:
    """æ‰å¹³é‚è¼¯ï¼Œç„¡åµŒå¥—"""
    if not path.exists():
        return ValidationResult.error("æª”æ¡ˆä¸å­˜åœ¨")
    
    if not path.suffix.lower() == '.dcm':
        return ValidationResult.error("é DICOM æª”æ¡ˆ")
        
    if not _has_required_tags(path):
        return ValidationResult.error("ç¼ºå°‘å¿…è¦æ¨™ç±¤")
    
    return ValidationResult.ok()
```

### ğŸ”´ åƒåœ¾ç¨‹å¼ç¢¼ç‰¹å¾µ (ç«‹å³æ‹’çµ•)
```python
# âŒ æ·±åº¦åµŒå¥— - è¶…é 3 å±¤ç¸®æ’
def bad_nested_function(data):
    if data:
        if data.has_images():
            for image in data.images:
                if image.is_valid():
                    if image.type == 'T1':
                        if image.has_reformatted():
                            # é€™è£¡å·²ç¶“ 6 å±¤ç¸®æ’äº†ï¼åƒåœ¾ï¼
                            return process_reformatted_t1(image)

# âŒ ç‰¹æ®Šæƒ…æ³æ»¿å¤©é£›
def bad_processor_selection(sequence_type: str):
    if sequence_type == 'T1':
        return T1Processor()
    elif sequence_type == 'T2':
        return T2Processor()  
    elif sequence_type == 'DWI':
        return DWIProcessor()
    elif sequence_type == 'T1_REFORMATTED':  # ç‰¹æ®Šæƒ…æ³é–‹å§‹äº†
        return SpecialT1Processor()
    elif sequence_type == 'T2_REFORMATTED':  # æ›´å¤šç‰¹æ®Šæƒ…æ³
        return SpecialT2Processor()
    # ... ç„¡çª®ç„¡ç›¡çš„ç‰¹æ®Šæƒ…æ³

# âŒ éåº¦æŠ½è±¡ï¼Œè§£æ±ºä¸å­˜åœ¨çš„å•é¡Œ
class AbstractProcessorFactoryBuilder:
    """ç†è«–ä¸Šå„ªé›…ï¼Œå¯¦éš›ä¸Šåƒåœ¾"""
    def create_factory(self) -> AbstractProcessorFactory:
        return ConcreteProcessorFactory(
            self.get_processor_registry(),
            self.get_configuration_manager(),
            self.get_dependency_injector()
        )
```

## Linus å¼ç¨‹å¼ç¢¼å¯©æŸ¥æ¸…å–®

### ç«‹å³æª¢æŸ¥é …ç›®
1. **ç¸®æ’å±¤æ•¸**: è¶…é 3 å±¤ï¼Ÿâ†’ ğŸ”´ é‡æ–°è¨­è¨ˆ
2. **å‡½æ•¸é•·åº¦**: è¶…é 20 è¡Œï¼Ÿâ†’ ğŸŸ¡ è€ƒæ…®æ‹†åˆ†  
3. **if/else éˆ**: è¶…é 3 å€‹åˆ†æ”¯ï¼Ÿâ†’ ğŸ”´ ç”¨è³‡æ–™çµæ§‹
4. **ç‰¹æ®Šæƒ…æ³**: æœ‰ "special_case" è®Šæ•¸ï¼Ÿâ†’ ğŸ”´ é‡æ–°æ€è€ƒè¨­è¨ˆ
5. **æŠ½è±¡å±¤æ•¸**: è¶…é 2 å±¤æŠ½è±¡ï¼Ÿâ†’ ğŸ”´ éåº¦å·¥ç¨‹

### é†«å­¸å½±åƒç‰¹å®šæª¢æŸ¥
```python
# âœ… å¿…é ˆé€šéçš„é†«å­¸å½±åƒæª¢æŸ¥
def medical_code_review_checklist(code: str) -> ReviewResult:
    """Linus é¢¨æ ¼é†«å­¸å½±åƒç¨‹å¼ç¢¼å¯©æŸ¥"""
    issues = []
    
    # 1. DICOM æ¨™ç±¤è™•ç†æª¢æŸ¥
    if 'pydicom' in code and 'get(' not in code:
        issues.append("ğŸ”´ æœªä½¿ç”¨å®‰å…¨çš„ DICOM æ¨™ç±¤å­˜å–")
    
    # 2. REFORMATTED æª¢æ¸¬æª¢æŸ¥  
    if any(seq in code for seq in ['T1', 'T2']) and 'REFORMATTED' not in code:
        issues.append("ğŸ”´ ç¼ºå°‘ REFORMATTED æª¢æ¸¬")
    
    # 3. å‘å¾Œç›¸å®¹æ€§æª¢æŸ¥
    if 'breaking_change' in code.lower():
        issues.append("ğŸ”´ å¯èƒ½ç ´å£å‘å¾Œç›¸å®¹æ€§")
    
    # 4. è¤‡é›œæ€§æª¢æŸ¥
    indentation_levels = max(line.count('    ') for line in code.split('\n'))
    if indentation_levels > 3:
        issues.append(f"ğŸ”´ ç¸®æ’éæ·±: {indentation_levels} å±¤")
    
    return ReviewResult(issues)
```

## ç¨‹å¼ç¢¼æ”¹é€²æŒ‡ä»¤

### æ¶ˆé™¤ç‰¹æ®Šæƒ…æ³
```python
# ğŸ”´ ä¹‹å‰ï¼šç‰¹æ®Šæƒ…æ³æ»¿å¤©é£›
def process_image_old(image_type: str, is_reformatted: bool):
    if image_type == 'T1':
        if is_reformatted:
            return process_t1_reformatted()
        else:
            return process_t1_normal()
    elif image_type == 'T2':
        if is_reformatted:
            return process_t2_reformatted()
        else:
            return process_t2_normal()
    # ... æ›´å¤šç‰¹æ®Šæƒ…æ³

# ğŸŸ¢ ä¹‹å¾Œï¼šGood Taste è§£æ±ºæ–¹æ¡ˆ
PROCESSORS = {
    ('T1', False): process_t1_normal,
    ('T1', True): process_t1_reformatted,
    ('T2', False): process_t2_normal, 
    ('T2', True): process_t2_reformatted,
}

def process_image_new(image_type: str, is_reformatted: bool):
    """ç„¡ç‰¹æ®Šæƒ…æ³ï¼Œè³‡æ–™çµæ§‹é©…å‹•"""
    processor = PROCESSORS.get((image_type, is_reformatted))
    if not processor:
        raise ValueError(f"ä¸æ”¯æ´çš„å½±åƒé¡å‹: {image_type}")
    return processor()
```

### æ‰å¹³åŒ–é‚è¼¯
```python  
# ğŸ”´ ä¹‹å‰ï¼šæ·±åº¦åµŒå¥—
def validate_and_process_old(path: Path):
    if path.exists():
        if path.is_file():
            if path.suffix == '.dcm':
                data = load_dicom(path)
                if data:
                    if data.is_valid():
                        return process_dicom(data)
                    else:
                        raise ValueError("ç„¡æ•ˆ DICOM")
                else:
                    raise ValueError("è¼‰å…¥å¤±æ•—")
            else:
                raise ValueError("é DICOM æª”æ¡ˆ")
        else:
            raise ValueError("ä¸æ˜¯æª”æ¡ˆ")
    else:
        raise ValueError("æª”æ¡ˆä¸å­˜åœ¨")

# ğŸŸ¢ ä¹‹å¾Œï¼šEarly returnï¼Œæ‰å¹³é‚è¼¯
def validate_and_process_new(path: Path):
    """Early returnï¼Œç„¡åµŒå¥—"""
    if not path.exists():
        raise ValueError("æª”æ¡ˆä¸å­˜åœ¨")
    
    if not path.is_file():
        raise ValueError("ä¸æ˜¯æª”æ¡ˆ")
    
    if path.suffix != '.dcm':
        raise ValueError("é DICOM æª”æ¡ˆ")
    
    data = load_dicom(path)
    if not data:
        raise ValueError("è¼‰å…¥å¤±æ•—")
    
    if not data.is_valid():
        raise ValueError("ç„¡æ•ˆ DICOM")
    
    return process_dicom(data)
```

## å¯©æŸ¥è¼¸å‡ºæ ¼å¼

### æ¨™æº–å¯©æŸ¥å›æ‡‰
```
ã€å“å‘³è©•ç´šã€‘ğŸ”´ åƒåœ¾
ã€è‡´å‘½ç¼ºé™·ã€‘å‡½æ•¸æœ‰ 6 å±¤ç¸®æ’ï¼Œå®Œå…¨ç„¡æ³•ç¶­è­·
ã€æ”¹é€²æ–¹å‘ã€‘
1. ç”¨ Early Return æ¶ˆé™¤åµŒå¥—
2. å°‡è™•ç†é‚è¼¯æå–åˆ°ç¨ç«‹å‡½æ•¸
3. ç”¨å­—å…¸æ›¿ä»£ if/else éˆ
ã€ä¿®å¾©å¾Œã€‘[æä¾›å…·é«”çš„æ”¹é€²ç¨‹å¼ç¢¼]
```

### æ‹’çµ•ç†ç”±æ¨¡æ¿
```
âŒ æ‹’çµ•åŸå› ï¼šé€™æ˜¯åœ¨è§£æ±ºä¸å­˜åœ¨çš„å•é¡Œ
çœŸæ­£çš„å•é¡Œæ˜¯ï¼š[æŒ‡å‡ºå¯¦éš›éœ€è¦è§£æ±ºçš„å•é¡Œ]
å»ºè­°ï¼š[æä¾›å¯¦ç”¨çš„æ›¿ä»£æ–¹æ¡ˆ]
```

## Linus é‡‘å¥æ‡‰ç”¨

- **"å¥½ç¨‹å¼ç¢¼æ²’æœ‰ç‰¹æ®Šæƒ…æ³"** â†’ çœ‹åˆ° if/else éˆå°±é‡æ§‹
- **"å¦‚æœéœ€è¦è¶…é 3 å±¤ç¸®æ’ï¼Œä½ å·²ç¶“å®Œè›‹äº†"** â†’ ç«‹å³è¦æ±‚é‡å¯«
- **"ç³Ÿç³•çš„ç¨‹å¼è¨­è¨ˆå¸«æ“”å¿ƒç¨‹å¼ç¢¼ï¼Œå„ªç§€çš„ç¨‹å¼è¨­è¨ˆå¸«æ“”å¿ƒè³‡æ–™çµæ§‹"** â†’ å„ªå…ˆæª¢æŸ¥è³‡æ–™çµæ§‹è¨­è¨ˆ
- **"ç†è«–å’Œå¯¦è¸æœ‰æ™‚è¡çªï¼Œç†è«–è¼¸"** â†’ æ‹’çµ•éåº¦æŠ½è±¡çš„è¨­è¨ˆ

è¨˜ä½ï¼šæˆ‘å€‘ä¸æ˜¯åœ¨å¯«å­¸è¡“è«–æ–‡ï¼Œæˆ‘å€‘æ˜¯åœ¨å¯«èƒ½å¤ æ‹¯æ•‘ç”Ÿå‘½çš„é†«å­¸è»Ÿé«”ã€‚ç°¡æ½”ã€å¯¦ç”¨ã€å¯é  - é€™å°±æ˜¯æ¨™æº–ã€‚
