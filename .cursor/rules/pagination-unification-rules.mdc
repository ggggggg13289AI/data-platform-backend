# API Pagination Unification Rules
# glob pattern(s) for applicable files: "studies/**/*.py", "config/**/*.py", "tests/**/*.py"

## 規格
- **模式**: Offset/Limit
  - Request: `offset>=0`、`1<=limit<=100`（預設 20）
  - Response 統一格式：
    {
      "items": [...],
      "pagination": { "total", "offset", "limit", "page", "pages" }
    }
  - 計算：`page = (offset // limit) + 1`；`pages = (total + limit - 1) // limit`
- **端點**：
  - 報告 API：維持 Offset/Limit（含 `/search` 與 `/search/paginated`）。
  - 研究 API：將 `/search`（與相關列表/匯出）改為 Offset/Limit。
- **錯誤處理**：
  - 400：無效參數（offset<0 或 limit<1）
  - 200：offset>=total 時回傳空 `items` 與正確的 `pagination`。
- **效能目標**：
  - p95：首頁 ≤100ms、offset=10,000 ≤200ms、offset≈末頁 ≤300ms。
  - 禁全表掃描，必要索引：`reports(is_latest, verified_at desc)`、`studies(exam_status, checkin_datetime desc)` 等。

## 實作要點
- `studies/pagination.py`：
  - 更新 `PaginationBase` 衍生類輸入為 `offset/limit`；輸出含 `PaginationMetadata`。
  - 嚴格參數標準化（下限/上限/型別），避免負值與過大頁面。
- 端點簽名（研究 API）：
  - 由 `page/page_size` → `offset/limit`，並補齊回應 `pagination` 區塊。
- 測試：
  - 邊界（offset=0、極大 offset、limit=1/100、offset>=total）。
  - 效能 smoke（確保使用 `LIMIT/OFFSET` 並走索引）。
  - 文件契約測試（回應欄位完整且一致）。

## 驗收清單
- [ ] 研究 API `/search` 已改為 Offset/Limit 參數。
- [ ] 所有分頁回應皆含 `pagination.total/offset/limit/page/pages`。
- [ ] 無效參數與超界邏輯符合錯誤處理規則。
- [ ] 性能基準符合 p95 目標；慢查詢具告警或記錄。
- [ ] 文件（API contract/遷移指南）已更新並對齊。
