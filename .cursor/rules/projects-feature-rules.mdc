# Projects Feature Implementation Rules
# glob pattern(s) for applicable files: "studies/**/{models.py,project_service.py,project_api.py,permissions.py}", "studies/migrations/**/*.py", "tests/test_project_*.py"

## 範圍
- 3 模型：`Project`、`ProjectMember`、`StudyProjectAssignment`（唯一鍵/索引完備）。
- 22 個 API 端點（列表/CRUD、生命週期、研究分配、成員、搜尋與統計）。
- 服務層與權限層（4 角色：Owner/Admin/Editor/Viewer）。
- 7 日完成路線圖與品質關卡（依 `_tasks` 文檔）。

## 實作原則
- 三層架構：`project_api.py`（路由）→ `project_service.py`（商務邏輯）→ `models.py`（ORM）。
- 權限集中：`permissions.py` 提供 `can_view/edit/delete/manage_members/manage_studies` 等檢查，API 層僅組合調用。
- 交易一致性：批次分配/移除研究需具事務性與回滾安全。
- 效能：針對常用查詢加索引；避免 N+1，適用 `select_related/prefetch_related`。
- 回應契約：Pydantic schemas 清楚定義，與前端 `project.ts` 契合。

## 必要端點（摘要）
- CRUD：`GET/POST /projects`、`GET/PUT/DELETE /projects/:id`
- 生命週期：`POST /projects/:id/{archive|restore|duplicate}`
- 研究：`POST/DELETE/GET /projects/:id/studies`、`POST /projects/batch-assign`、`GET /studies/:studyId/projects`
- 成員：`POST /projects/:id/members`、`DELETE /projects/:id/members/:userId`、`PUT /projects/:id/members/:userId`、`GET /projects/:id/members`
- 搜尋/統計：`GET /projects/search`、`GET /projects/:id/statistics`

## 測試與品質
- 單元測試：模型、服務層、權限檢查（覆蓋率 ≥ 80%）。
- API 測試：22 端點 100% 覆蓋，含權限/錯誤案例。
- 整合測試：核心工作流（建立→分配→統計；成員增改刪）與併發情境。
- 效能目標：p95 < 500ms；查詢走索引、記錄慢查詢。

## 里程碑（對齊 `_tasks`）
- Day 1-2：模型/遷移、服務層、權限與其測試。
- Day 3-5：22 端點與 API 測試完成。
- Day 6：前後端整合驗證並修正契約差異。
- Day 7：效能優化、安全性檢查、文件與發佈。

## 依賴與風險
- 依賴：分頁統一改造合併；`studies` 既有模型相容性。
- 風險緩解：事務/索引/權限全面測試；提供回滾策略與部署檢查清單。
