---
description: Django ORM 與原生 SQL 互動規則（本專案）
globs: "studies/models.py", "studies/*service.py", "studies/migrations/*.py"
priority: high
category: database
alwaysApply: true
dependencies: ["django-performance-optimization-rules.mdc", "django-error-handling-rules.mdc"]
---

# 資料庫互動規則（Django）

## ORM 優先
- 單記錄：`objects.get()`；清單：`objects.filter()`
- 關聯：外鍵使用 `select_related()`，多對多/反向使用 `prefetch_related()`
- 註解/聚合：使用 `annotate()`、`Count()`；避免 N+1

## 原生 SQL（僅必要時）
- 僅於確實需要效能或複雜查詢時使用
- 必須使用參數化查詢（`%s` 佔位，不可字串拼接使用者輸入）
- 例：`StudyService.get_studies_queryset` 以 `LIMIT/OFFSET` 在 DB 端分頁

## 事務與一致性
- 跨模型寫入使用 `@transaction.atomic`
- 事務範圍最小化；捕獲 DB 例外並轉為 `DatabaseQueryError`

## 索引與約束
- 只在遷移中新增/修改索引；不可手動改已提交的 migration
- 常用索引：`Study.exam_id`、`Report.report_id`、`is_latest,-verified_at` 等
- 唯一性：`StudyProjectAssignment(project, study)` 等複合唯一

## 分頁與排序
- 一律在 DB 端套用 `LIMIT/OFFSET`（或 ORM 切片）
- 排序欄位必須走索引（如 `order_datetime`、`verified_at`）

## 禁止
- 禁止以 f-string 將使用者輸入拼接進 SQL
- 禁止長事務與非必要的鎖表操作
