---
description: 錯誤處理與日誌規則（Django + Django Ninja，本專案）
globs: "studies/**/*.py", "config/**/*.py"
priority: critical
category: error-handling
alwaysApply: true
---

# 錯誤處理規則（本專案）

## 原則
- 早期返回、守衛子句；快樂路徑保持扁平
- Service 層拋出 `studies.exceptions.*`（例如 `StudyNotFoundError`, `DatabaseQueryError`）
- API 層負責將領域例外轉為 HTTP 回應（`Http404`、422/400）

## 轉換與結構
- 404：資源不存在（例如 Study、Report）
- 422/400：參數錯誤或驗證失敗
- 500：未預期錯誤（記錄詳細 log 並讓框架處理）

## 日誌
- 使用已配置 logger 名稱：`studies`、`request_timing`
- 記錄內容包含：錯誤型別、訊息、traceback、必要上下文

## 禁止
- 禁止 `except Exception: pass`
- 禁止模糊訊息（例如 `raise Exception("出錯了")`）
- 禁止在 Service 直接回傳 HTTP 相關物件（保持分層）
