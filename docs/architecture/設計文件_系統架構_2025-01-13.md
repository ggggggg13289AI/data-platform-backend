# è¨­è¨ˆæ–‡ä»¶ - ç³»çµ±æ¶æ§‹èˆ‡æŠ€è¡“è¨­è¨ˆ

**æ–‡ä»¶ç‰ˆæœ¬**: v1.0
**å»ºç«‹æ—¥æœŸ**: 2025-01-13
**ç³»çµ±ç‰ˆæœ¬**: v1.1.0
**ä½œè€…**: Development Team with Expert Panel Review

---

## 1. ç³»çµ±æ¶æ§‹æ¦‚è¿°

### 1.1 æ¶æ§‹åŸå‰‡
æœ¬ç³»çµ±éµå¾ª **"å‹™å¯¦å¤§æ–¼ç†è«–"** (Pragmatic Over Theoretical) çš„è¨­è¨ˆå“²å­¸ï¼š

**æ ¸å¿ƒåŸå‰‡**:
- **æ‰å¹³åŒ–è¨­è¨ˆ** (Flat Design): å–®ä¸€ appï¼Œé¿å…éåº¦å·¥ç¨‹
- **ç›´æ¥å‡½å¼å‘¼å«**: ä¸ä½¿ç”¨ Django signalsï¼Œé¿å…éš±è—ä¾è³´
- **äº‹å¯¦å„ªæ–¼å‡è¨­**: æ‰€æœ‰æ±ºç­–åŸºæ–¼å¯¦éš›éœ€æ±‚ï¼Œä¸åšæœªä¾†æ¨æ¸¬
- **ç¨‹å¼ç¢¼å„ªæ–¼æ–‡ä»¶**: æ–‡ä»¶è¼”åŠ©ç†è§£ï¼Œä½†ç¨‹å¼ç¢¼æ˜¯çœŸç†ä¾†æº

**è¨­è¨ˆæ ¼è¨€**:
> "Evidence > Assumptions | Code > Documentation | Efficiency > Verbosity"

### 1.2 æŠ€è¡“å †ç–Š

#### å¾Œç«¯æ¡†æ¶
```yaml
æ ¸å¿ƒæ¡†æ¶:
  - Django: 5.0.0          # ç©©å®šçš„ Web framework
  - Django Ninja: 1.3.0    # FastAPI-style REST API
  - Pydantic: v2.x         # è³‡æ–™é©—è­‰èˆ‡åºåˆ—åŒ–

èªè­‰èˆ‡å®‰å…¨:
  - django-ninja-jwt: 5.3.5    # JWT ç„¡ç‹€æ…‹èªè­‰
  - django-cors-headers: 4.3.1  # CORS æ”¯æ´

è³‡æ–™åº«èˆ‡å¿«å–:
  - PostgreSQL: Production     # é—œè¯å¼è³‡æ–™åº«
  - Redis: Production Cache    # å¿«å–å±¤ (å¯é¸)
  - SQLite: Development        # é–‹ç™¼ç’°å¢ƒ

æ¸¬è©¦èˆ‡å“è³ª:
  - Django unittest: å…§å»ºæ¸¬è©¦æ¡†æ¶
  - Coverage.py: è¦†è“‹ç‡åˆ†æ
```

#### API è¨­è¨ˆé¢¨æ ¼
- **RESTful**: è³‡æºå°å‘è¨­è¨ˆ
- **JSON**: çµ±ä¸€è³‡æ–™æ ¼å¼
- **ISO 8601**: æ—¥æœŸæ™‚é–“æ ¼å¼
- **HTTP Status Codes**: èªæ„åŒ–ç‹€æ…‹ç¢¼

---

## 2. è³‡æ–™åº«è¨­è¨ˆ

### 2.1 è³‡æ–™æ¨¡å‹æ¶æ§‹

#### ER é—œä¿‚åœ–æ¦‚å¿µ
```
User (Djangoå…§å»º)
  â”‚
  â”œâ”€â”€[1:N]â”€â”€â†’ Project (created_by)
  â”‚
  â””â”€â”€[M:N]â”€â”€â†’ Project (through ProjectMember)

Project
  â”‚
  â”œâ”€â”€[1:N]â”€â”€â†’ ProjectMember (roles)
  â”‚
  â””â”€â”€[M:N]â”€â”€â†’ Study (through StudyProjectAssignment)

Study (ç¨ç«‹äº‹å¯¦è¡¨)

Report
  â””â”€â”€[1:N]â”€â”€â†’ ReportVersion (ç‰ˆæœ¬æ§åˆ¶)
```

### 2.2 æ ¸å¿ƒè³‡æ–™è¡¨

#### Study (medical_examinations_fact)
**è¨­è¨ˆç†å¿µ**: æ‰å¹³åŒ–äº‹å¯¦è¡¨ï¼Œæ‰€æœ‰è³‡æ–™å–®è¡¨å­˜æ”¾

```sql
CREATE TABLE medical_examinations_fact (
    exam_id VARCHAR(100) PRIMARY KEY,
    medical_record_no VARCHAR(100),
    patient_name VARCHAR(200) NOT NULL,
    patient_gender VARCHAR(10),
    patient_age INTEGER,
    exam_status VARCHAR(20) NOT NULL,
    exam_source VARCHAR(50) NOT NULL,
    exam_item VARCHAR(200) NOT NULL,
    order_datetime TIMESTAMP NOT NULL,
    certified_physician VARCHAR(200),
    -- ... å…¶ä»–æ¬„ä½ ...

    -- ç´¢å¼•ç­–ç•¥
    INDEX idx_status_datetime (exam_status, order_datetime DESC),
    INDEX idx_source_datetime (exam_source, order_datetime DESC),
    INDEX idx_patient_name (patient_name),
    INDEX idx_exam_item (exam_item)
);
```

**ç´¢å¼•ç­–ç•¥**:
- **è¤‡åˆç´¢å¼•**: (status, datetime), (source, datetime) æ”¯æ´å¸¸è¦‹æŸ¥è©¢
- **å–®æ¬„ç´¢å¼•**: patient_name, exam_item æ”¯æ´æœå°‹
- **é¿å…éåº¦ç´¢å¼•**: åƒ…ç´¢å¼•å¯¦éš›æŸ¥è©¢æ¬„ä½

#### Report (one_page_text_report_v2)
**è¨­è¨ˆç†å¿µ**: å…§å®¹å»é‡ + ç‰ˆæœ¬æ§åˆ¶

```sql
CREATE TABLE one_page_text_report_v2 (
    uid VARCHAR(100) PRIMARY KEY,
    report_id VARCHAR(100) UNIQUE,
    title VARCHAR(500) NOT NULL,
    content_raw TEXT NOT NULL,
    content_hash VARCHAR(64) NOT NULL,  -- SHA256
    version_number INTEGER DEFAULT 1,
    is_latest BOOLEAN DEFAULT TRUE,
    report_type VARCHAR(50),
    source_url VARCHAR(500),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    INDEX idx_content_hash (content_hash),
    INDEX idx_is_latest (is_latest),
    INDEX idx_report_id (report_id),
    INDEX idx_report_type (report_type)
);
```

**å»é‡é‚è¼¯**:
```python
# 1. è¨ˆç®— content_hash
hash = hashlib.sha256(content.encode()).hexdigest()

# 2. æŸ¥è©¢æ˜¯å¦å­˜åœ¨
existing = Report.objects.filter(content_hash=hash).first()

# 3. æ±ºç­–
if existing:
    if content == existing.content_raw:
        # ç›¸åŒå…§å®¹ï¼Œåƒ…æ›´æ–°æ™‚é–“
        existing.updated_at = now()
    else:
        # å…§å®¹è®Šæ›´ï¼Œå»ºç«‹æ–°ç‰ˆæœ¬
        existing.is_latest = False
        new_version = version_number + 1
else:
    # æ–°å ±å‘Š
    create_new(version_number=1)
```

#### Project (projects)
**è¨­è¨ˆç†å¿µ**: UUID ä¸»éµ + RBAC æ¬Šé™æ§åˆ¶

```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'active',
    tags JSONB DEFAULT '[]',
    study_count INTEGER DEFAULT 0,
    created_by_id INTEGER REFERENCES auth_user(id) ON DELETE RESTRICT,
    settings JSONB DEFAULT '{}',
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    INDEX idx_status_updated (status, updated_at DESC),
    INDEX idx_creator_created (created_by_id, created_at DESC),
    INDEX idx_study_count (study_count DESC)
);
```

#### ProjectMember (project_members)
**è¨­è¨ˆç†å¿µ**: Through model å¯¦ä½œè§’è‰²æ¬Šé™

```sql
CREATE TABLE project_members (
    id SERIAL PRIMARY KEY,
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES auth_user(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL,  -- owner/admin/editor/viewer
    joined_at TIMESTAMP DEFAULT NOW(),

    UNIQUE (project_id, user_id),
    INDEX idx_user_projects (user_id, joined_at DESC)
);
```

**è§’è‰²æ¬Šé™çŸ©é™£**:
| æ“ä½œ | owner | admin | editor | viewer |
|------|-------|-------|--------|--------|
| æŸ¥çœ‹å°ˆæ¡ˆ | âœ… | âœ… | âœ… | âœ… |
| ç·¨è¼¯å°ˆæ¡ˆ | âœ… | âœ… | âœ… | âŒ |
| æ–°å¢/ç§»é™¤ç ”ç©¶ | âœ… | âœ… | âœ… | âŒ |
| ç®¡ç†æˆå“¡ | âœ… | âœ… | âŒ | âŒ |
| åˆªé™¤å°ˆæ¡ˆ | âœ… | âŒ | âŒ | âŒ |
| è½‰ç§»æ‰€æœ‰æ¬Š | âœ… | âŒ | âŒ | âŒ |

#### ExportTask (report_export_tasks)
**è¨­è¨ˆç†å¿µ**: ä»»å‹™è¿½è¹¤ + æª”æ¡ˆéæœŸç®¡ç†

```sql
CREATE TABLE report_export_tasks (
    task_id VARCHAR(100) PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    query_params JSONB NOT NULL,
    export_format VARCHAR(20) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    total_records INTEGER DEFAULT 0,
    processed_records INTEGER DEFAULT 0,
    file_path VARCHAR(500),
    file_url VARCHAR(500),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,

    INDEX idx_user_created (user_id, created_at DESC),
    INDEX idx_status (status),
    INDEX idx_expires (expires_at)
);
```

### 2.3 è³‡æ–™åº«ç´¢å¼•ç­–ç•¥

#### è¤‡åˆç´¢å¼•è¨­è¨ˆåŸå‰‡
```python
# âœ… GOOD: æ”¯æ´å¸¸è¦‹æŸ¥è©¢æ¨¡å¼
Index(fields=['exam_status', '-order_datetime'])
# Query: WHERE status = ? ORDER BY datetime DESC

# âœ… GOOD: ç²¾ç¢ºæŸ¥è©¢ + æ’åº
Index(fields=['created_by', '-created_at'])
# Query: WHERE creator = ? ORDER BY created_at DESC

# âŒ AVOID: éåº¦ç´¢å¼•
Index(fields=['field1', 'field2', 'field3', 'field4'])
# Too many fields, unlikely to be fully utilized
```

#### ç´¢å¼•ç¶­è­·ç­–ç•¥
- å®šæœŸåˆ†ææŸ¥è©¢æ—¥èªŒ
- ç§»é™¤æœªä½¿ç”¨çš„ç´¢å¼•
- ç›£æ§ç´¢å¼•å¤§å°èˆ‡æ•ˆèƒ½

---

## 3. API è¨­è¨ˆ

### 3.1 RESTful è¨­è¨ˆåŸå‰‡

#### URL çµæ§‹
```
/api/v{version}/{resource}/{id}/{action}
/api/v1/projects/{project_id}/studies
```

**è¦å‰‡**:
- ä½¿ç”¨è¤‡æ•¸åè© (projects, studies, reports)
- è³‡æºå±¤ç´šçµæ§‹æ¸…æ™°
- å‹•ä½œä½¿ç”¨å­è³‡æº (archive, restore, duplicate)

#### HTTP æ–¹æ³•å°æ‡‰
```yaml
GET:    æŸ¥è©¢è³‡æº (å†ªç­‰)
POST:   å»ºç«‹è³‡æº / åŸ·è¡Œå‹•ä½œ
PUT:    å®Œæ•´æ›´æ–°è³‡æº (å†ªç­‰)
PATCH:  éƒ¨åˆ†æ›´æ–°è³‡æº
DELETE: åˆªé™¤è³‡æº (å†ªç­‰)
```

### 3.2 å›æ‡‰æ ¼å¼è¨­è¨ˆ

#### æˆåŠŸå›æ‡‰
```json
// å–®ä¸€è³‡æº
{
  "id": "uuid",
  "name": "Project Name",
  "status": "active",
  ...
}

// åˆ—è¡¨è³‡æº (åˆ†é )
{
  "items": [...],
  "count": 100,
  "page": 1,
  "page_size": 20
}

// æ“ä½œå›æ‡‰
{
  "status": "success",
  "message": "æ“ä½œæˆåŠŸ",
  "data": {...}
}
```

#### éŒ¯èª¤å›æ‡‰
```json
{
  "detail": "éŒ¯èª¤è¨Šæ¯æè¿°",
  "code": "ERROR_CODE",  // å¯é¸
  "field": "æ¬„ä½å"      // é©—è­‰éŒ¯èª¤æ™‚
}
```

**HTTP ç‹€æ…‹ç¢¼**:
```yaml
200 OK:          æˆåŠŸæŸ¥è©¢/æ›´æ–°
201 Created:     æˆåŠŸå»ºç«‹è³‡æº
204 No Content:  æˆåŠŸåˆªé™¤
400 Bad Request: è«‹æ±‚åƒæ•¸éŒ¯èª¤
401 Unauthorized: æœªèªè­‰
403 Forbidden:   æ¬Šé™ä¸è¶³
404 Not Found:   è³‡æºä¸å­˜åœ¨
500 Internal Server Error: ä¼ºæœå™¨éŒ¯èª¤
```

### 3.3 åˆ†é è¨­è¨ˆ

#### çµ±ä¸€åˆ†é æ¨¡å‹ (v1.1.0)
```python
class StandardPagination:
    page: int = Field(1, ge=1)           # 1-indexed
    page_size: int = Field(20, ge=1, le=100)

    @property
    def offset(self):
        return (self.page - 1) * self.page_size
```

**è¨­è¨ˆæ±ºç­–**:
- âœ… 1-indexed (ç¬¦åˆä½¿ç”¨è€…ç›´è¦º)
- âœ… page_size é™åˆ¶ 1-100 (é˜²æ­¢æ¿«ç”¨)
- âœ… çµ±ä¸€æ‰€æœ‰ç«¯é»ä½¿ç”¨ç›¸åŒæ¨¡å‹
- âŒ å»¢æ£„èˆŠçš„ offset/limit æ¨¡å‹

### 3.4 API ç‰ˆæœ¬æ§åˆ¶

#### ç‰ˆæœ¬ç­–ç•¥
```python
# URL versioning (ç•¶å‰ç­–ç•¥)
/api/v1/projects
/api/v2/projects  # æœªä¾†ç‰ˆæœ¬

# ç‰ˆæœ¬è½‰æ›
v1.x.x â†’ v2.0.0: ç§»é™¤ deprecated endpoints
v1.1.x â†’ v1.2.x: æ–°åŠŸèƒ½ï¼Œå‘å¾Œç›¸å®¹
v1.1.1 â†’ v1.1.2: Bug fixes
```

#### Deprecation æµç¨‹
1. **æ¨™è¨˜ DEPRECATED**: åœ¨å›æ‡‰ä¸­åŠ å…¥è­¦å‘Š
2. **æä¾›é·ç§»æŒ‡å¼•**: CLIENT_MIGRATION_GUIDE.md
3. **è¨­å®šç§»é™¤æ™‚ç¨‹**: è‡³å°‘ 2 å€‹ minor ç‰ˆæœ¬
4. **æ­£å¼ç§»é™¤**: Major version æ›´æ–°æ™‚

---

## 4. èªè­‰èˆ‡æˆæ¬Šè¨­è¨ˆ

### 4.1 JWT èªè­‰æµç¨‹

#### Token çµæ§‹
```json
// Access Token (HS256, 1 hour)
{
  "token_type": "access",
  "exp": 1705147200,        // éæœŸæ™‚é–“
  "iat": 1705143600,        // ç™¼è¡Œæ™‚é–“
  "jti": "unique-token-id", // Token ID
  "user_id": 1              // ç”¨æˆ¶ ID
}

// Refresh Token (HS256, 7 days)
{
  "token_type": "refresh",
  "exp": 1705752400,
  "iat": 1705143600,
  "jti": "unique-refresh-id",
  "user_id": 1
}
```

#### èªè­‰æµç¨‹åœ–
```
1. LOGIN
   Client â†’ POST /auth/login (username, password)
   Server â† {access_token, refresh_token, user}

2. API CALL
   Client â†’ GET /projects (Header: Authorization: Bearer {access_token})
   Server â†’ Validate token
   Server â† {projects: [...]}

3. TOKEN REFRESH
   Client â†’ POST /auth/refresh (refresh_token)
   Server â† {access: new_token}

4. LOGOUT
   Client â†’ POST /auth/logout
   Client â†’ Delete tokens from storage
```

### 4.2 è‡ªè¨‚ Token Schema

#### å•é¡Œ: å‰ç«¯æœŸæœ› access_token/refresh_token
#### è§£æ±º: è‡ªè¨‚ schema è½‰æ›æ¬„ä½å

```python
# Backend (django-ninja-jwt é è¨­)
{"access": "...", "refresh": "..."}

# Frontend æœŸæœ›
{"access_token": "...", "refresh_token": "..."}

# è§£æ±ºæ–¹æ¡ˆ: CustomTokenObtainPairOutSchema
class CustomTokenObtainPairOutSchema(Schema):
    access_token: str   # é‡æ–°å‘½å
    refresh_token: str  # é‡æ–°å‘½å
    user: UserInfo
    status: str = 'success'
    message: str = 'ç™»å…¥æˆåŠŸ'
```

### 4.3 æ¬Šé™æ§åˆ¶è¨­è¨ˆ

#### ç«¯é»æ¬Šé™çŸ©é™£
```python
# å…¬é–‹ç«¯é» (ç„¡éœ€èªè­‰)
PUBLIC = [
    'GET /api/v1/studies/search',
    'GET /api/v1/reports/search',
]

# JWT èªè­‰ç«¯é»
JWT_REQUIRED = [
    'POST /api/v1/projects',
    'GET /api/v1/auth/me',
    'POST /api/v1/auth/logout',
]

# è§’è‰²æ¬Šé™ç«¯é»
ROLE_BASED = [
    ('GET /api/v1/projects/{id}', 'view'),
    ('PUT /api/v1/projects/{id}', 'edit'),
    ('DELETE /api/v1/projects/{id}', 'delete'),
]
```

#### Permission Service
```python
class ProjectPermissionService:
    PERMISSIONS = {
        'owner': ['view', 'edit', 'delete', 'manage_members'],
        'admin': ['view', 'edit', 'manage_members'],
        'editor': ['view', 'edit'],
        'viewer': ['view'],
    }

    def has_permission(user, project, action) -> bool:
        member = get_member(user, project)
        if not member:
            return False
        return action in self.PERMISSIONS[member.role]
```

---

## 5. å¿«å–ç­–ç•¥è¨­è¨ˆ

### 5.1 å¿«å–å±¤ç´š

#### L1: Application Cache (Django ORM)
```python
# Query cache (è‡ªå‹•)
Model.objects.get(pk=1)  # Cached by Django
```

#### L2: Redis Cache (ç¯©é¸é¸é …)
```python
# å¿«å–ç­–ç•¥
CACHE_KEY = 'filter_options:reports'
TTL = 60 * 60 * 24  # 24 hours

# Graceful degradation
try:
    options = cache.get(CACHE_KEY)
    if not options:
        options = fetch_from_db()
        cache.set(CACHE_KEY, options, TTL)
except CacheError:
    logger.warning("Cache failed, fallback to DB")
    options = fetch_from_db()
```

### 5.2 å¿«å–å¤±æ•ˆç­–ç•¥

#### ä¸»å‹•å¤±æ•ˆ
```python
# è³‡æ–™è®Šæ›´æ™‚æ¸…é™¤å¿«å–
@transaction.atomic
def create_report(data):
    report = Report.objects.create(**data)
    cache.delete('filter_options:reports')  # å¤±æ•ˆå¿«å–
    return report
```

#### è¢«å‹•å¤±æ•ˆ
```python
# TTL éæœŸè‡ªå‹•å¤±æ•ˆ
# æ¸›å°‘è¤‡é›œæ€§ï¼Œå®¹å¿çŸ­æš«ä¸ä¸€è‡´
```

### 5.3 å¿«å–ç›£æ§

```python
# Middleware è¨˜éŒ„å¿«å–å‘½ä¸­ç‡
class CacheMonitoringMiddleware:
    def process_request(request):
        if cache_hit:
            metrics.increment('cache.hit')
        else:
            metrics.increment('cache.miss')
```

---

## 6. éŒ¯èª¤è™•ç†è¨­è¨ˆ

### 6.1 ä¾‹å¤–è™•ç†æ¶æ§‹

#### é›†ä¸­å¼ä¾‹å¤–è™•ç†å™¨
```python
# studies/exceptions.py
class BaseAPIException(Exception):
    status_code = 500
    default_message = "Internal Server Error"

class ValidationError(BaseAPIException):
    status_code = 400

class UnauthorizedError(BaseAPIException):
    status_code = 401

class ForbiddenError(BaseAPIException):
    status_code = 403
```

#### Django Ninja æ•´åˆ
```python
@api.exception_handler(BaseAPIException)
def handle_api_exception(request, exc):
    return api.create_response(
        request,
        {"detail": str(exc)},
        status=exc.status_code
    )
```

### 6.2 éŒ¯èª¤è¨Šæ¯åœ‹éš›åŒ–

```python
ERROR_MESSAGES = {
    'INVALID_CREDENTIALS': {
        'zh-TW': 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤',
        'en': 'Invalid username or password'
    },
    'PERMISSION_DENIED': {
        'zh-TW': 'æ¬Šé™ä¸è¶³',
        'en': 'Permission denied'
    }
}

def get_error_message(code, lang='zh-TW'):
    return ERROR_MESSAGES[code][lang]
```

---

## 7. æ•ˆèƒ½æœ€ä½³åŒ–è¨­è¨ˆ

### 7.1 è³‡æ–™åº«æŸ¥è©¢æœ€ä½³åŒ–

#### Select Related & Prefetch
```python
# âŒ N+1 Query Problem
projects = Project.objects.all()
for project in projects:
    print(project.created_by.username)  # Extra query each!

# âœ… Optimized
projects = Project.objects.select_related('created_by').all()
for project in projects:
    print(project.created_by.username)  # No extra query
```

#### ç´¢å¼•ä½¿ç”¨é©—è­‰
```sql
-- æª¢æŸ¥æŸ¥è©¢è¨ˆç•«
EXPLAIN ANALYZE
SELECT * FROM projects
WHERE status = 'active'
ORDER BY updated_at DESC
LIMIT 20;

-- é©—è­‰ç´¢å¼•ä½¿ç”¨
-- Should use: idx_status_updated
```

### 7.2 API æ•ˆèƒ½ç›£æ§

#### Request Timing Middleware
```python
class RequestTimingMiddleware:
    def __call__(self, request):
        start = time.time()
        response = self.get_response(request)
        duration = time.time() - start

        logger.info(f"{request.method} {request.path} {duration:.3f}s")
        return response
```

#### æ•ˆèƒ½æŒ‡æ¨™
```python
PERFORMANCE_TARGETS = {
    'simple_query': 100,    # ms (P95)
    'search_query': 500,    # ms (P95)
    'complex_query': 1000,  # ms (P95)
}
```

---

## 8. æ¸¬è©¦ç­–ç•¥è¨­è¨ˆ

### 8.1 æ¸¬è©¦é‡‘å­—å¡”

```
        /\
       /E2E\      (å°‘é‡: æ•´åˆæ¸¬è©¦)
      /------\
     /  API   \   (ä¸­é‡: API æ¸¬è©¦)
    /----------\
   / Unit Tests \ (å¤§é‡: å–®å…ƒæ¸¬è©¦)
  /--------------\
```

### 8.2 æ¸¬è©¦è¦†è“‹ç›®æ¨™

```python
# Phase 2 æˆæœ
COVERAGE_REPORT = {
    'overall': 85%,
    'models': 90%,
    'services': 85%,
    'api': 80%,
    'middleware': 90%,
}

# æ¸¬è©¦é¡åˆ¥åˆ†å¸ƒ
TESTS = {
    'models': 15,        # Model é‚è¼¯
    'services': 20,      # æ¥­å‹™é‚è¼¯
    'api': 18,           # API ç«¯é»
    'caching': 6,        # å¿«å–ç­–ç•¥
    'permissions': 4,    # æ¬Šé™æ§åˆ¶
}
```

---

## 9. éƒ¨ç½²æ¶æ§‹è¨­è¨ˆ

### 9.1 ç’°å¢ƒåˆ†é›¢

```yaml
Development:
  Database: SQLite
  Cache: locmem
  Debug: True

Staging:
  Database: PostgreSQL
  Cache: Redis
  Debug: False

Production:
  Database: PostgreSQL (replica)
  Cache: Redis (cluster)
  Debug: False
  Monitoring: Enabled
```

### 9.2 é…ç½®ç®¡ç†

```python
# studies/config.py
class Config:
    # Database
    DATABASE_URL = env('DATABASE_URL')

    # Cache
    REDIS_URL = env('REDIS_URL', default=None)
    CACHE_TTL = env.int('CACHE_TTL', default=86400)

    # JWT
    JWT_SECRET = env('SECRET_KEY')
    JWT_ACCESS_LIFETIME = timedelta(hours=1)
    JWT_REFRESH_LIFETIME = timedelta(days=7)

    # API
    PAGE_SIZE_DEFAULT = 20
    PAGE_SIZE_MAX = 100
```

---

## 10. å®‰å…¨è¨­è¨ˆ

### 10.1 å®‰å…¨æª¢æŸ¥æ¸…å–®

```yaml
Authentication:
  - âœ… JWT token ä½¿ç”¨ HS256
  - âœ… Token åŒ…å«éæœŸæ™‚é–“
  - âš ï¸ Token blacklist æ©Ÿåˆ¶å¾…é©—è­‰

Authorization:
  - âœ… RBAC æ¬Šé™æ§åˆ¶
  - âœ… ç«¯é»æ¬Šé™æª¢æŸ¥
  - âœ… 403 Forbidden å›æ‡‰

Input Validation:
  - âœ… Pydantic schema é©—è­‰
  - âœ… åƒæ•¸ç¯„åœæª¢æŸ¥
  - âœ… SQL injection é˜²è­· (ORM)

CORS:
  - âœ… django-cors-headers
  - âœ… ALLOWED_ORIGINS é…ç½®

Rate Limiting:
  - â³ æœªå¯¦ä½œ (å…§éƒ¨ç³»çµ±)
```

---

## 11. è¨­è¨ˆæ±ºç­–è¨˜éŒ„ (ADR)

### ADR-001: æ‰å¹³åŒ–è¨­è¨ˆ vs æ¨¡çµ„åŒ–è¨­è¨ˆ
**æ±ºç­–**: æ¡ç”¨æ‰å¹³åŒ–è¨­è¨ˆ
**ç†ç”±**:
- å°ˆæ¡ˆè¦æ¨¡å¯æ§
- é¿å…éåº¦å·¥ç¨‹
- ç›´æ¥å‡½å¼å‘¼å«æ˜“æ–¼è¿½è¹¤
- ç¬¦åˆ "å‹™å¯¦å„ªæ–¼ç†è«–" åŸå‰‡

### ADR-002: JWT vs Session èªè­‰
**æ±ºç­–**: æ¡ç”¨ JWT ç„¡ç‹€æ…‹èªè­‰
**ç†ç”±**:
- å‰ç«¯å·²ä½¿ç”¨ localStorage å„²å­˜ token
- ç„¡éœ€ server-side session ç®¡ç†
- æ°´å¹³æ“´å±•è¼ƒå®¹æ˜“
- æ”¯æ´è·¨åŸŸèªè­‰

### ADR-003: çµ±ä¸€åˆ†é æ¨¡å‹
**æ±ºç­–**: page/page_size (1-indexed)
**ç†ç”±**:
- ç¬¦åˆä½¿ç”¨è€…ç›´è¦º (å¾ 1 é–‹å§‹)
- çµ±ä¸€æ‰€æœ‰ API è¡Œç‚º
- å‰ç«¯å¯¦ä½œç°¡å–®
- å»¢æ£„ offset/limit é¿å…æ··æ·†

### ADR-004: å ±å‘Šå»é‡ç­–ç•¥
**æ±ºç­–**: åŸºæ–¼ content_hash (SHA256)
**ç†ç”±**:
- ç²¾ç¢ºå»é‡ (å…§å®¹å®Œå…¨ç›¸åŒ)
- æ•ˆèƒ½å¯æ¥å— (ç´¢å¼• hash æ¬„ä½)
- ç‰ˆæœ¬æ§åˆ¶æ¸…æ™°
- å„²å­˜ç©ºé–“ç¯€çœ

---

## 12. æœªä¾†è€ƒæ…®äº‹é …

### 12.1 å¯æ“´å±•æ€§
- è³‡æ–™åˆ†å€ (Partitioning)
- è®€å¯«åˆ†é›¢ (Read Replicas)
- å¾®æœå‹™æ‹†åˆ† (è‹¥è¦æ¨¡æ“´å¤§)

### 12.2 å¯è§€æ¸¬æ€§
- åˆ†æ•£å¼è¿½è¹¤ (Distributed Tracing)
- APM æ•´åˆ (Application Performance Monitoring)
- æ—¥èªŒèšåˆ (Log Aggregation)

### 12.3 åŠŸèƒ½å¢å¼·
- å…¨æ–‡æœå°‹ (Elasticsearch)
- å¯¦æ™‚é€šçŸ¥ (WebSocket)
- æª”æ¡ˆå„²å­˜ (S3/MinIO)

---

## 13. æ–‡ä»¶ä¿®è¨‚æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è®Šæ›´æ‘˜è¦ |
|------|------|------|---------|
| v1.0 | 2025-01-13 | Dev Team | åˆç‰ˆå»ºç«‹ |

---

**æ–‡ä»¶ç‹€æ…‹**: ğŸ“ ACTIVE
**ç›¸é—œæ–‡ä»¶**: éœ€æ±‚è¦æ ¼_å°ˆæ¡ˆç¸½è¦½_2025-01-13.md

ğŸ¤– Generated with Claude Code Expert Panel Review
