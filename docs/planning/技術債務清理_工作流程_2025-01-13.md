# æŠ€è¡“å‚µå‹™æ¸…ç† - è©³ç´°å¯¦ä½œå·¥ä½œæµç¨‹
**ç‰ˆæœ¬**: v1.1.0 â†’ v1.2.0
**æ–‡ä»¶æ—¥æœŸ**: 2025-01-13
**ç‹€æ…‹**: å¯¦ä½œè¦åŠƒ

---

## ğŸ“‹ ç›®éŒ„

1. [åŸ·è¡Œæ‘˜è¦](#1-åŸ·è¡Œæ‘˜è¦)
2. [å„ªå…ˆç´šæ’åºèˆ‡æ™‚ç¨‹è¦åŠƒ](#2-å„ªå…ˆç´šæ’åºèˆ‡æ™‚ç¨‹è¦åŠƒ)
3. [DEBT-003: TokenBlackList æ–‡ä»¶åŒ–](#3-debt-003-tokenblacklist-æ–‡ä»¶åŒ–)
4. [DEBT-004: Pagination é‚è¼¯é‡æ§‹](#4-debt-004-pagination-é‚è¼¯é‡æ§‹)
5. [DEBT-005: éŒ¯èª¤è™•ç†çµ±ä¸€åŒ–](#5-debt-005-éŒ¯èª¤è™•ç†çµ±ä¸€åŒ–)
6. [DEBT-001: Legacy Endpoint é·ç§»è¦åŠƒ](#6-debt-001-legacy-endpoint-é·ç§»è¦åŠƒ)
7. [DEBT-002: Export é™åˆ¶æå‡ (v1.3.0)](#7-debt-002-export-é™åˆ¶æå‡-v130)
8. [DEBT-006: è¼¸å…¥é©—è­‰è£œå¼· (v1.3.0)](#8-debt-006-è¼¸å…¥é©—è­‰è£œå¼·-v130)
9. [Git Workflow ç­–ç•¥](#9-git-workflow-ç­–ç•¥)
10. [æ¸¬è©¦ç­–ç•¥](#10-æ¸¬è©¦ç­–ç•¥)
11. [é¢¨éšªè©•ä¼°èˆ‡ç·©è§£](#11-é¢¨éšªè©•ä¼°èˆ‡ç·©è§£)
12. [å®Œæˆæª¢æŸ¥æ¸…å–®](#12-å®Œæˆæª¢æŸ¥æ¸…å–®)

---

## 1. åŸ·è¡Œæ‘˜è¦

### å‚µå‹™ç¸½è¦½

```yaml
æŠ€è¡“å‚µå‹™ç¸½è¨ˆ: 6 items
HIGH Priority: 3 items (æœ¬é€±å®Œæˆ)
MEDIUM Priority: 3 items (v1.2.0 - v1.3.0)
é ä¼°ç¸½æ™‚é–“: 59 å°æ™‚
ç›®æ¨™ç‰ˆæœ¬: v1.2.0 (2025-02-28)
```

### å„ªå…ˆç´šçŸ©é™£

```
HIGH Impact / HIGH Urgency:
  âœ… DEBT-003: TokenBlackList æ–‡ä»¶ (3h) - æœ¬é€±å…§
  âœ… DEBT-004: Pagination é‡æ§‹ (8h) - v1.2.0
  âœ… DEBT-005: éŒ¯èª¤è™•ç†çµ±ä¸€ (12h) - v1.2.0

MEDIUM Impact / MEDIUM Urgency:
  ğŸŸ¡ DEBT-001: Legacy endpoint (4h) - v1.2.0
  ğŸŸ¡ DEBT-002: Export é™åˆ¶ (24h) - v1.3.0
  ğŸŸ¡ DEBT-006: è¼¸å…¥é©—è­‰ (16h) - v1.3.0
```

### åŸ·è¡Œç­–ç•¥

**Phase 1 (Week 1)**: å¿«é€Ÿå‹åˆ© â†’ DEBT-003 æ–‡ä»¶åŒ–
**Phase 2 (Week 2-3)**: æ¶æ§‹æ”¹å–„ â†’ DEBT-004 + DEBT-005
**Phase 3 (Week 4)**: é·ç§»è¦åŠƒ â†’ DEBT-001 æ–‡ä»¶èˆ‡ç›£æ§
**Phase 4 (Month 2-3)**: åŠŸèƒ½å¢å¼· â†’ DEBT-002 + DEBT-006

---

## 2. å„ªå…ˆç´šæ’åºèˆ‡æ™‚ç¨‹è¦åŠƒ

### æ™‚ç¨‹ç”˜ç‰¹åœ–

```
Week 1       Week 2       Week 3       Week 4       Month 2-3
  â”‚            â”‚            â”‚            â”‚              â”‚
  â”œâ”€ DEBT-003 (æ–‡ä»¶)                                   â”‚
  â”‚            â”œâ”€ DEBT-004 (Pagination)                â”‚
  â”‚            â”œâ”€ DEBT-005 (Error Handling)            â”‚
  â”‚            â”‚            â”œâ”€ DEBT-001 (è¦åŠƒ)          â”‚
  â”‚            â”‚            â”‚            â”œâ”€ DEBT-002 (Export)
  â”‚            â”‚            â”‚            â”‚              â”œâ”€ DEBT-006 (Validation)
```

### ä¾è³´é—œä¿‚åœ–

```yaml
DEBT-003: ç„¡ä¾è³´ (å¯ç«‹å³é–‹å§‹)
DEBT-004: ç„¡ä¾è³´ (å¯ç«‹å³é–‹å§‹)
DEBT-005: ä¾è³´ DEBT-004 (éœ€è¦çµ±ä¸€çš„ pagination error handling)
DEBT-001: ä¾è³´ DEBT-004 (ç¢ºä¿æ–° endpoint ç©©å®š)
DEBT-002: ç„¡ä¾è³´ (ç¨ç«‹åŠŸèƒ½)
DEBT-006: ä¾è³´ DEBT-005 (çµ±ä¸€ validation error format)
```

### è³‡æºåˆ†é…

```yaml
Week_1 (3h):
  - DEBT-003: 3h (Technical Writer + Backend Developer)

Week_2 (10h):
  - DEBT-004: 8h (Backend Developer)
  - DEBT-005 Phase 1: 2h (Architecture Analysis)

Week_3 (10h):
  - DEBT-005 Phase 2: 10h (Implementation + Testing)

Week_4 (4h):
  - DEBT-001: 4h (Documentation + Monitoring Setup)

Month_2-3 (40h):
  - DEBT-002: 24h (Backend Developer + DevOps)
  - DEBT-006: 16h (Backend Developer + Security Review)
```

---

## 3. DEBT-003: TokenBlackList æ–‡ä»¶åŒ–

### å•é¡Œé™³è¿°

**Current State**:
- TokenBlackList æ©Ÿåˆ¶å·²å¯¦ä½œä½†æœªæ–‡ä»¶åŒ–
- ç¶­è­·äººå“¡ä¸äº†è§£ blacklist æ¸…ç†ç­–ç•¥
- æ•…éšœæ’æŸ¥å›°é›£ï¼Œç„¡ç›£æ§å»ºè­°

**Impact**:
- ğŸŸ¡ MEDIUM: ç¶­è­·å›°é›£ï¼Œæ•…éšœæ’æŸ¥æ™‚é–“é•·
- TokenBlackList è¡¨å¯èƒ½ç„¡é™å¢é•·
- JWT å•é¡Œé›£ä»¥è¨ºæ–·

**Target State**:
- å®Œæ•´çš„ TokenBlackList é‹ä½œèªªæ˜æ–‡ä»¶
- æ¸…ç†ç­–ç•¥èˆ‡è‡ªå‹•åŒ–è…³æœ¬
- ç›£æ§æŒ‡æ¨™èˆ‡å‘Šè­¦å»ºè­°

### å¯¦ä½œæ­¥é©Ÿ

```yaml
Step_1_Documentation_Creation (2h):
  æª”æ¡ˆ: docs/authentication/token-blacklist.md

  å…§å®¹æ¶æ§‹:
    1. TokenBlackList æ©Ÿåˆ¶èªªæ˜:
       - ROTATE_REFRESH_TOKENS é…ç½®
       - BLACKLIST_AFTER_ROTATION è¡Œç‚º
       - Token ç”Ÿå‘½é€±æœŸç®¡ç†

    2. è³‡æ–™è¡¨çµæ§‹:
       - OutstandingToken model
       - BlacklistedToken model
       - ç´¢å¼•ç­–ç•¥

    3. é‹ä½œæµç¨‹:
       - Token ç”Ÿæˆæ™‚è¨˜éŒ„ OutstandingToken
       - Refresh æ™‚èˆŠ token åŠ å…¥ BlacklistedToken
       - é©—è­‰æ™‚æª¢æŸ¥ blacklist ç‹€æ…‹

    4. æ¸…ç†ç­–ç•¥:
       - éæœŸ token æ¸…ç†é€±æœŸ (æ¯æ—¥)
       - ä¿ç•™ç­–ç•¥ (30 å¤© audit trail)
       - æ‰‹å‹•æ¸…ç†æŒ‡ä»¤

    5. ç›£æ§å»ºè­°:
       - OutstandingToken æ•¸é‡ç›£æ§
       - BlacklistedToken å¢é•·ç‡
       - è³‡æ–™è¡¨å¤§å°å‘Šè­¦é–¾å€¼

Step_2_Cleanup_Script_Creation (30min):
  æª”æ¡ˆ: scripts/cleanup_expired_tokens.py

  åŠŸèƒ½:
    - æ¸…ç†éæœŸçš„ OutstandingToken (> 30 days)
    - æ¸…ç†å°æ‡‰çš„ BlacklistedToken
    - è¨˜éŒ„æ¸…ç†çµ±è¨ˆ (deleted count)
    - Dry-run mode æ”¯æ´

  æ’ç¨‹å»ºè­°:
    - Cron: æ¯æ—¥ 02:00 åŸ·è¡Œ
    - ç›£æ§: Sentry notification on errors

Step_3_Django_Management_Command (30min):
  æª”æ¡ˆ: studies/management/commands/cleanup_tokens.py

  Usage:
    python manage.py cleanup_tokens --days=30 --dry-run
    python manage.py cleanup_tokens --days=30

  è¼¸å‡º:
    Deleted X OutstandingTokens
    Deleted Y BlacklistedTokens
    Database size reduced by Z MB
```

### Git Workflow

```yaml
Branch: docs/debt-003-tokenblacklist-documentation
Commits:
  1. "docs: Add TokenBlackList mechanism documentation"
  2. "feat: Add token cleanup management command"
  3. "chore: Add token cleanup cron job configuration"

PR_Title: "docs: Complete TokenBlackList documentation and cleanup automation (DEBT-003)"
PR_Labels: [documentation, technical-debt, authentication]
```

### æ¸¬è©¦ç­–ç•¥

```yaml
Documentation_Review:
  - Technical review by auth system owner
  - Readability review by DevOps team
  - Accuracy verification against code

Cleanup_Script_Testing:
  - Unit test with mock data (100 expired tokens)
  - Integration test with test database
  - Dry-run validation (no actual deletion)
  - Verify cleanup statistics accuracy

Management_Command_Testing:
  - Test --dry-run flag behavior
  - Test --days parameter validation
  - Test with 0, 1, 100, 1000 expired tokens
  - Verify database integrity after cleanup
```

### æ™‚é–“ä¼°ç®—

```
æ–‡ä»¶æ’°å¯«:         2.0 å°æ™‚
Cleanup script:   0.5 å°æ™‚
Management cmd:   0.5 å°æ™‚
æ¸¬è©¦èˆ‡é©—è­‰:       0.5 å°æ™‚
Review & PR:      0.5 å°æ™‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½è¨ˆ:             4.0 å°æ™‚
```

### æˆåŠŸæ¨™æº–

- âœ… æ–‡ä»¶å®Œæ•´æ¶µè“‹ TokenBlackList é‹ä½œæ©Ÿåˆ¶
- âœ… Cleanup management command å¯æ­£å¸¸åŸ·è¡Œ
- âœ… Dry-run mode æº–ç¢ºé è¦½æ¸…ç†çµæœ
- âœ… æ–‡ä»¶å¯©æŸ¥é€šé (technical + readability)
- âœ… PR åˆä½µè‡³ master

---

## 4. DEBT-004: Pagination é‚è¼¯é‡æ§‹

### å•é¡Œé™³è¿°

**Current State**:
- `studies/pagination.py`: StudyPagination, ProjectPagination
- `studies/report_api.py`: ReportPagination class (lines 94-148)
- ä¸‰å€‹ pagination classes æœ‰é‡è¤‡é‚è¼¯

**Code Duplication**:
```python
# ç›¸åŒé‚è¼¯åœ¨ä¸‰è™•é‡è¤‡:
1. page/page_size åƒæ•¸é©—è­‰
2. offset è¨ˆç®—: (page - 1) * page_size
3. get_items() æ–¹æ³•
4. get_response_data() æ–¹æ³•
5. get_total_pages() è¨ˆç®—
```

**Impact**:
- ğŸŸ¡ MEDIUM: ç¶­è­·æˆæœ¬é«˜ï¼Œä¸€è‡´æ€§é¢¨éšª
- Bug fix éœ€è¦åŒæ­¥ä¸‰è™•
- æ–°å¢ pagination åŠŸèƒ½å›°é›£

**Target State**:
- çµ±ä¸€çš„ `BasePagination` class
- æ‰€æœ‰ API ä½¿ç”¨ç›¸åŒçš„ pagination é‚è¼¯
- DRY principle å¯¦ç¾

### æ¶æ§‹è¨­è¨ˆ

```python
# studies/pagination.py

class BasePagination:
    """
    çµ±ä¸€çš„ pagination åŸºç¤é¡åˆ¥ã€‚

    æä¾›æ¨™æº–çš„ page/page_size åˆ†é åŠŸèƒ½:
    - page: é ç¢¼ (1-indexed, default 1)
    - page_size: æ¯é ç­†æ•¸ (default 20, max 100)
    - total: ç¸½ç­†æ•¸
    - pages: ç¸½é æ•¸
    """

    def __init__(self, queryset, page: int = 1, page_size: int = 20):
        self.queryset = queryset
        self.page = max(page, 1)
        self.page_size = self._validate_page_size(page_size)
        self.total = self._get_total_count()

    def _validate_page_size(self, page_size: int) -> int:
        """é©—è­‰ä¸¦æ­£è¦åŒ– page_size"""
        if page_size <= 0:
            return 20  # default
        return min(page_size, 100)  # max 100

    def _get_total_count(self) -> int:
        """å–å¾—ç¸½ç­†æ•¸ (æ”¯æ´ QuerySet èˆ‡ RawQuerySet)"""
        # å¯¦ä½œç´°ç¯€...

    def get_page_number(self) -> int:
        return self.page

    def get_total_pages(self) -> int:
        if self.page_size <= 0:
            return 1
        return (self.total + self.page_size - 1) // self.page_size

    def get_items(self):
        """å–å¾—ç•¶å‰é é¢çš„é …ç›®"""
        offset = (self.page - 1) * self.page_size
        end = offset + self.page_size
        return self.queryset[offset:end]

    def get_response_data(self, items: List) -> dict:
        """å–å¾— pagination response è³‡æ–™"""
        return {
            'items': items,
            'total': self.total,
            'page': self.get_page_number(),
            'page_size': self.page_size,
            'pages': self.get_total_pages(),
        }


class ReportPagination(BasePagination):
    """Report API å°ˆç”¨çš„ pagination (ç¹¼æ‰¿ BasePagination)"""

    def __init__(self, queryset, page: int = 1, page_size: int = 20):
        super().__init__(queryset, page, page_size)

    # å¯ä»¥è¦†å¯«ç‰¹å®šæ–¹æ³•å¦‚æœéœ€è¦


class StudyPagination(PaginationBase, BasePagination):
    """
    Study API pagination (æ•´åˆ Django Ninja PaginationBase)

    æ³¨æ„: é€™å€‹éœ€è¦åŒæ™‚ç¹¼æ‰¿ Django Ninja çš„ PaginationBase
    å’Œæˆ‘å€‘çš„ BasePaginationï¼Œä»¥ä¿æŒ Django Ninja è£é£¾å™¨ç›¸å®¹æ€§
    """
    # å¯¦ä½œç´°ç¯€...


class ProjectPagination(PaginationBase, BasePagination):
    """Project API pagination"""
    # å¯¦ä½œç´°ç¯€...
```

### å¯¦ä½œæ­¥é©Ÿ

```yaml
Step_1_Create_BasePagination (3h):
  æª”æ¡ˆ: studies/pagination.py

  ä»»å‹™:
    1. å¯¦ä½œ BasePagination class:
       - __init__(queryset, page, page_size)
       - _validate_page_size()
       - _get_total_count() (æ”¯æ´ QuerySet & RawQuerySet)
       - get_page_number()
       - get_total_pages()
       - get_items()
       - get_response_data()

    2. æå–å…±ç”¨é‚è¼¯:
       - å¾ ReportPagination æå–æ ¸å¿ƒé‚è¼¯
       - ä¿ç•™ RawQuerySet æ”¯æ´ (from StudyPagination)
       - çµ±ä¸€åƒæ•¸é©—è­‰é‚è¼¯

    3. æ–‡ä»¶è¨»è§£:
       - Docstrings for all methods
       - Usage examples
       - Migration guide comments

Step_2_Refactor_ReportPagination (2h):
  æª”æ¡ˆ: studies/report_api.py

  è®Šæ›´:
    Before:
      class ReportPagination:
          def __init__(self, queryset, page, page_size):
              # é‡è¤‡çš„é‚è¼¯...

    After:
      from .pagination import BasePagination

      class ReportPagination(BasePagination):
          pass  # æˆ–è¦†å¯«ç‰¹å®šæ–¹æ³•

    ç§»é™¤:
      - Lines 94-148 çš„é‡è¤‡é‚è¼¯
      - ä¿ç•™ ReportPagination åç¨± (å‘å¾Œå…¼å®¹)

Step_3_Refactor_StudyPagination (1.5h):
  æª”æ¡ˆ: studies/pagination.py

  è®Šæ›´:
    class StudyPagination(PaginationBase, BasePagination):
        # æ•´åˆå…©å€‹åŸºç¤é¡åˆ¥
        # ä¿æŒ Django Ninja è£é£¾å™¨ç›¸å®¹æ€§
        # ä½¿ç”¨ BasePagination çš„å…±ç”¨é‚è¼¯

Step_4_Refactor_ProjectPagination (1.5h):
  æª”æ¡ˆ: studies/pagination.py

  è®Šæ›´:
    class ProjectPagination(PaginationBase, BasePagination):
        # ç§»é™¤é‡è¤‡é‚è¼¯
        # ä½¿ç”¨ BasePagination çš„æ ¸å¿ƒæ–¹æ³•
        # ä¿ç•™ Project-specific çš„ RBAC é‚è¼¯

Step_5_Testing (2h):
  æ¸¬è©¦æ¶µè“‹:
    - BasePagination å–®å…ƒæ¸¬è©¦
    - ä¸‰å€‹ pagination classes çš„æ•´åˆæ¸¬è©¦
    - å‘å¾Œå…¼å®¹æ€§æ¸¬è©¦ (API å›æ‡‰æ ¼å¼ä¸è®Š)
    - Edge cases: page=0, page_size=0, page_size=1000
```

### æ¸¬è©¦ç­–ç•¥

```yaml
Unit_Tests:
  test_base_pagination.py:
    - test_init_with_defaults
    - test_page_number_validation (page=0, -1, 1000)
    - test_page_size_validation (0, -10, 1, 100, 1000)
    - test_total_count_queryset
    - test_total_count_raw_queryset
    - test_get_items_first_page
    - test_get_items_middle_page
    - test_get_items_last_page
    - test_get_total_pages_calculation
    - test_response_data_format

Integration_Tests:
  test_report_pagination_integration.py:
    - test_report_search_paginated_endpoint
    - test_pagination_metadata_accuracy
    - test_edge_cases (empty results, single item)

  test_study_pagination_integration.py:
    - test_study_search_with_pagination
    - test_filter_options_preserved

  test_project_pagination_integration.py:
    - test_project_list_pagination
    - test_rbac_in_paginated_results

Backward_Compatibility_Tests:
  - API response format unchanged
  - Query parameters work as before
  - Edge cases handled identically
```

### Git Workflow

```yaml
Branch: refactor/debt-004-unified-pagination
Commits:
  1. "refactor: Create BasePagination class with shared logic"
  2. "refactor: Update ReportPagination to use BasePagination"
  3. "refactor: Update StudyPagination to use BasePagination"
  4. "refactor: Update ProjectPagination to use BasePagination"
  5. "test: Add comprehensive pagination tests"

PR_Title: "refactor: Unify pagination logic with BasePagination (DEBT-004)"
PR_Labels: [refactoring, technical-debt, DRY]
```

### æ™‚é–“ä¼°ç®—

```
BasePagination å¯¦ä½œ:        3.0 å°æ™‚
ReportPagination é‡æ§‹:      2.0 å°æ™‚
StudyPagination é‡æ§‹:       1.5 å°æ™‚
ProjectPagination é‡æ§‹:     1.5 å°æ™‚
æ¸¬è©¦æ’°å¯«èˆ‡åŸ·è¡Œ:              2.0 å°æ™‚
Code review & èª¿æ•´:         1.0 å°æ™‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½è¨ˆ:                       11.0 å°æ™‚
```

### é¢¨éšªè©•ä¼°

```yaml
Risk_1_Backward_Compatibility:
  æ©Ÿç‡: MEDIUM (30%)
  å½±éŸ¿: HIGH (API å®¢æˆ¶ç«¯å¯èƒ½ä¸­æ–·)
  ç·©è§£:
    - å®Œæ•´çš„ backward compatibility tests
    - API response format é©—è­‰
    - Staging ç’°å¢ƒå®Œæ•´æ¸¬è©¦

Risk_2_Django_Ninja_Integration:
  æ©Ÿç‡: LOW (15%)
  å½±éŸ¿: MEDIUM (è£é£¾å™¨å¯èƒ½ä¸ç›¸å®¹)
  ç·©è§£:
    - ä¿ç•™ PaginationBase ç¹¼æ‰¿
    - æ¸¬è©¦ @paginate decorator è¡Œç‚º
    - åƒè€ƒ Django Ninja å®˜æ–¹ç¯„ä¾‹

Risk_3_RawQuerySet_Support:
  æ©Ÿç‡: MEDIUM (25%)
  å½±éŸ¿: HIGH (search æ•ˆèƒ½é€€åŒ–)
  ç·©è§£:
    - ä¿ç•™ RawQuerySet count é‚è¼¯
    - æ•ˆèƒ½åŸºæº–æ¸¬è©¦é©—è­‰
    - SQL query profiling
```

### æˆåŠŸæ¨™æº–

- âœ… BasePagination class å¯¦ä½œå®Œæˆ
- âœ… æ‰€æœ‰é‡è¤‡é‚è¼¯ç§»é™¤ (DRY)
- âœ… æ‰€æœ‰ API endpoint åŠŸèƒ½æ­£å¸¸
- âœ… API response format å®Œå…¨ç›¸å®¹
- âœ… æ¸¬è©¦è¦†è“‹ç‡ â‰¥95%
- âœ… æ•ˆèƒ½ç„¡é€€åŒ– (åŸºæº–æ¸¬è©¦é©—è­‰)
- âœ… Code review é€šé
- âœ… PR åˆä½µè‡³ master

---

## 5. DEBT-005: éŒ¯èª¤è™•ç†çµ±ä¸€åŒ–

### å•é¡Œé™³è¿°

**Current State**:
```python
# studies/exceptions.py æœ‰å®Œæ•´çš„ exception hierarchy
# ä½† report_api.py æœªä½¿ç”¨

# report_api.py (BEFORE):
try:
    # ... operation
except Exception as e:
    logger.error(f'Operation failed: {str(e)}')
    raise  # æ‹‹å‡ºé€šç”¨ Exception
```

**Problems**:
1. éŒ¯èª¤å›æ‡‰æ ¼å¼ä¸ä¸€è‡´
2. æœªä½¿ç”¨ custom exceptions (StudyServiceError, etc.)
3. æœªä½¿ç”¨ `to_error_dict()` æ ¼å¼åŒ–éŒ¯èª¤
4. å®¢æˆ¶ç«¯é›£ä»¥ç¨‹å¼åŒ–è™•ç†éŒ¯èª¤
5. ç¼ºå°‘ error codes èˆ‡ request_id tracking

**Impact**:
- ğŸŸ¡ MEDIUM: å®¢æˆ¶ç«¯éŒ¯èª¤è™•ç†è¤‡é›œ
- æ•…éšœæ’æŸ¥å›°é›£ (ç¼ºå°‘ request_id)
- API éŒ¯èª¤å›æ‡‰ä¸å°ˆæ¥­

**Target State**:
```python
# çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ¨¡å¼:

from .exceptions import (
    ReportNotFoundError,
    InvalidReportParameterError,
    to_error_dict
)

try:
    # ... operation
except Report.DoesNotExist:
    raise ReportNotFoundError(report_id)
except ValueError as e:
    raise InvalidReportParameterError('param', value, str(e))

# Ninja error handler è‡ªå‹•ä½¿ç”¨ to_error_dict()
```

### æ¶æ§‹è¨­è¨ˆ

```python
# studies/exceptions.py (æ–°å¢ Report exceptions)

class ReportServiceError(Exception):
    """Base exception for report service operations"""
    pass


class ReportNotFoundError(ReportServiceError):
    """Report not found by report_id"""

    def __init__(self, report_id: str):
        self.report_id = report_id
        super().__init__(f"Report not found: {report_id}")


class InvalidReportParameterError(ReportServiceError):
    """Invalid report search/filter parameter"""

    def __init__(self, param: str, value: Any, reason: str):
        self.param = param
        self.value = value
        self.reason = reason
        super().__init__(f"Invalid {param}={value}: {reason}")


class ReportVersionConflictError(ReportServiceError):
    """Version conflict during report update"""

    def __init__(self, report_id: str, expected: int, actual: int):
        self.report_id = report_id
        self.expected_version = expected
        self.actual_version = actual
        super().__init__(
            f"Version conflict for {report_id}: "
            f"expected v{expected}, got v{actual}"
        )


# æ›´æ–° ERROR_CODES mapping
ERROR_CODES = {
    # Study errors...
    StudyNotFoundError: 'STUDY_NOT_FOUND',
    InvalidSearchParameterError: 'INVALID_SEARCH_PARAMETER',
    # Report errors (æ–°å¢)
    ReportNotFoundError: 'REPORT_NOT_FOUND',
    InvalidReportParameterError: 'INVALID_REPORT_PARAMETER',
    ReportVersionConflictError: 'REPORT_VERSION_CONFLICT',
}


# æ›´æ–° to_error_dict() æ”¯æ´ Report exceptions
def to_error_dict(exception, request_id=None):
    error_dict = {
        'error': {
            'code': get_error_code(exception),
            'message': str(exception),
        }
    }

    # Report-specific details
    if isinstance(exception, ReportNotFoundError):
        error_dict['error']['details'] = {
            'report_id': exception.report_id,
        }
    elif isinstance(exception, InvalidReportParameterError):
        error_dict['error']['details'] = {
            'param': exception.param,
            'value': str(exception.value),
            'reason': exception.reason,
        }
    elif isinstance(exception, ReportVersionConflictError):
        error_dict['error']['details'] = {
            'report_id': exception.report_id,
            'expected_version': exception.expected_version,
            'actual_version': exception.actual_version,
        }

    if request_id:
        error_dict['error']['request_id'] = request_id

    return error_dict
```

### å¯¦ä½œæ­¥é©Ÿ

```yaml
Step_1_Add_Report_Exceptions (2h):
  æª”æ¡ˆ: studies/exceptions.py

  æ–°å¢ exceptions:
    - ReportServiceError (base)
    - ReportNotFoundError
    - InvalidReportParameterError
    - ReportVersionConflictError

  æ›´æ–°:
    - ERROR_CODES mapping
    - to_error_dict() function
    - get_error_code() function

  æ–‡ä»¶:
    - Docstrings with examples
    - Usage guidelines

Step_2_Create_Error_Handler_Middleware (2h):
  æª”æ¡ˆ: studies/middleware.py

  åŠŸèƒ½:
    - çµ±ä¸€è™•ç† ServiceError exceptions
    - è‡ªå‹•ç”Ÿæˆ request_id (UUID)
    - å‘¼å« to_error_dict() æ ¼å¼åŒ–
    - è¨˜éŒ„ error logs with request_id

  Django Ninja integration:
    @api.exception_handler(ReportServiceError)
    def handle_report_error(request, exc):
        request_id = str(uuid.uuid4())
        error_dict = to_error_dict(exc, request_id)
        logger.error(f"[{request_id}] {exc}")
        return api.create_response(
            request,
            error_dict,
            status=get_http_status(exc)
        )

Step_3_Refactor_Report_API_Error_Handling (4h):
  æª”æ¡ˆ: studies/report_api.py

  è®Šæ›´æ‰€æœ‰ endpoints:
    import_report():
      - Replace generic Exception
      - Add InvalidReportParameterError for validation

    search_reports():
      - Add InvalidReportParameterError for param validation
      - Preserve deprecation warning

    search_reports_paginated():
      - Add InvalidReportParameterError
      - Add proper page/page_size validation errors

    get_report_detail():
      Before:
        except Report.DoesNotExist:
            raise Exception(f'Report not found: {report_id}')

      After:
        except Report.DoesNotExist:
            raise ReportNotFoundError(report_id)

    get_report_versions():
      - Add ReportNotFoundError
      - Add InvalidReportParameterError

Step_4_Refactor_Report_Service_Errors (2h):
  æª”æ¡ˆ: studies/report_service.py

  è®Šæ›´:
    - ä½¿ç”¨ custom exceptions å–ä»£ generic exceptions
    - Validation å¤±æ•—æ™‚æ‹‹å‡º InvalidReportParameterError
    - Database errors åŒ…è£ç‚º ReportServiceError

Step_5_Update_Error_Documentation (1h):
  æª”æ¡ˆ: docs/api/error-handling.md

  å…§å®¹:
    1. æ¨™æº–éŒ¯èª¤æ ¼å¼:
       {
         "error": {
           "code": "ERROR_CODE",
           "message": "Human readable message",
           "details": {...},
           "request_id": "uuid"
         }
       }

    2. Error Codes æ¸…å–®:
       - STUDY_NOT_FOUND (404)
       - REPORT_NOT_FOUND (404)
       - INVALID_SEARCH_PARAMETER (400)
       - INVALID_REPORT_PARAMETER (400)
       - REPORT_VERSION_CONFLICT (409)

    3. å®¢æˆ¶ç«¯éŒ¯èª¤è™•ç†ç¯„ä¾‹:
       - JavaScript fetch() example
       - Python requests example
       - Error code switch/case patterns

Step_6_Add_HTTP_Status_Mapping (1h):
  æª”æ¡ˆ: studies/exceptions.py

  æ–°å¢:
    HTTP_STATUS_CODES = {
        StudyNotFoundError: 404,
        ReportNotFoundError: 404,
        InvalidSearchParameterError: 400,
        InvalidReportParameterError: 400,
        ReportVersionConflictError: 409,
        CacheUnavailableError: 503,
        DatabaseQueryError: 500,
    }

    def get_http_status(exception) -> int:
        return HTTP_STATUS_CODES.get(
            type(exception),
            500  # Internal Server Error
        )
```

### æ¸¬è©¦ç­–ç•¥

```yaml
Unit_Tests:
  test_report_exceptions.py:
    - test_report_not_found_error_message
    - test_invalid_report_parameter_error_details
    - test_report_version_conflict_error
    - test_error_code_mapping
    - test_to_error_dict_format
    - test_http_status_mapping

Integration_Tests:
  test_report_error_handling.py:
    Scenario: Report not found
      Request: GET /api/v1/reports/NONEXISTENT
      Expected:
        Status: 404
        Body: {
          "error": {
            "code": "REPORT_NOT_FOUND",
            "message": "Report not found: NONEXISTENT",
            "details": {"report_id": "NONEXISTENT"},
            "request_id": "..."
          }
        }

    Scenario: Invalid pagination parameter
      Request: GET /api/v1/reports/search/paginated?page=-1
      Expected:
        Status: 400
        Body: {
          "error": {
            "code": "INVALID_REPORT_PARAMETER",
            "message": "Invalid page=-1: Must be >= 1",
            "details": {...}
          }
        }

E2E_Tests:
  - Test error handling across all report endpoints
  - Verify request_id in logs matches response
  - Verify error format consistency
```

### Git Workflow

```yaml
Branch: refactor/debt-005-unified-error-handling
Commits:
  1. "feat: Add Report-specific exception classes"
  2. "feat: Add error handler middleware with request_id"
  3. "refactor: Update report_api error handling"
  4. "refactor: Update report_service error handling"
  5. "docs: Add comprehensive error handling documentation"
  6. "test: Add error handling tests"

PR_Title: "refactor: Unify error handling with custom exceptions (DEBT-005)"
PR_Labels: [refactoring, technical-debt, error-handling]
```

### æ™‚é–“ä¼°ç®—

```
Report exceptions å¯¦ä½œ:     2.0 å°æ™‚
Error handler middleware:   2.0 å°æ™‚
report_api é‡æ§‹:            4.0 å°æ™‚
report_service é‡æ§‹:        2.0 å°æ™‚
éŒ¯èª¤è™•ç†æ–‡ä»¶:                1.0 å°æ™‚
æ¸¬è©¦æ’°å¯«èˆ‡åŸ·è¡Œ:              3.0 å°æ™‚
Code review & èª¿æ•´:         1.0 å°æ™‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½è¨ˆ:                       15.0 å°æ™‚
```

### æˆåŠŸæ¨™æº–

- âœ… æ‰€æœ‰ Report API ä½¿ç”¨ custom exceptions
- âœ… éŒ¯èª¤å›æ‡‰æ ¼å¼çµ±ä¸€ (åŒ…å« error code, details, request_id)
- âœ… HTTP status codes æ­£ç¢ºå°æ‡‰
- âœ… éŒ¯èª¤è™•ç†æ–‡ä»¶å®Œæ•´
- âœ… æ¸¬è©¦è¦†è“‹ç‡ â‰¥90%
- âœ… æ‰€æœ‰ API endpoints éŒ¯èª¤è™•ç†ä¸€è‡´
- âœ… Code review é€šé
- âœ… PR åˆä½µè‡³ master

---

## 6. DEBT-001: Legacy Endpoint é·ç§»è¦åŠƒ

### å•é¡Œé™³è¿°

**Current State**:
- `/api/v1/reports/search` ä½¿ç”¨ `limit` åƒæ•¸ (legacy)
- `/api/v1/reports/search/paginated` ä½¿ç”¨ `page/page_size` (æ–°æ¨™æº–)
- Legacy endpoint å·²æ¨™è¨˜ DEPRECATED
- CLIENT_MIGRATION_GUIDE.md å·²å­˜åœ¨

**Target State**:
- ç›£æ§ legacy endpoint ä½¿ç”¨é‡
- å®¢æˆ¶ç«¯é·ç§»å®Œæˆ
- v2.0.0 ç§»é™¤ legacy endpoint

### å¯¦ä½œæ­¥é©Ÿ

```yaml
Step_1_Add_Usage_Monitoring (2h):
  æª”æ¡ˆ: studies/report_api.py

  è®Šæ›´ search_reports():
    from django.core.cache import cache

    @report_router.get('/search', response=List[ReportResponse])
    def search_reports(...):
        # Logæ¯æ¬¡å‘¼å«
        cache_key = f"legacy_search_usage_{timezone.now().date()}"
        cache.incr(cache_key, 1)
        cache.expire(cache_key, 86400 * 90)  # ä¿ç•™ 90 å¤©

        logger.warning(
            f'DEPRECATED: legacy /search endpoint called. '
            f'Daily usage: {cache.get(cache_key, 0)}. '
            f'User-Agent: {request.META.get("HTTP_USER_AGENT")}. '
            f'Migrate to /search/paginated.'
        )
        # ... existing logic

Step_2_Create_Usage_Dashboard (1h):
  æª”æ¡ˆ: studies/management/commands/legacy_endpoint_stats.py

  åŠŸèƒ½:
    - é¡¯ç¤º legacy endpoint æ¯æ—¥ä½¿ç”¨é‡
    - é¡¯ç¤ºéå» 30 å¤©è¶¨å‹¢
    - è­˜åˆ¥ä¸»è¦ä½¿ç”¨è€… (User-Agent)

  Usage:
    python manage.py legacy_endpoint_stats

  Output:
    Legacy Endpoint Usage Statistics
    ================================

    Last 7 days:
    2025-01-13: 1,234 calls
    2025-01-12:   987 calls
    ...

    Trend: â–¼ 15% decrease

    Top User-Agents:
    1. python-requests/2.31.0: 45%
    2. PostmanRuntime/7.32.3: 30%
    3. curl/7.81.0: 25%

Step_3_Add_Deprecation_Headers (30min):
  æª”æ¡ˆ: studies/report_api.py

  è®Šæ›´:
    @report_router.get('/search', ...)
    def search_reports(request, ...):
        # Add response headers
        response = api.create_response(...)
        response['Deprecation'] = 'true'
        response['Sunset'] = '2025-06-01'  # v2.0.0 release date
        response['Link'] = (
            '</api/v1/reports/search/paginated>; '
            'rel="alternate"; title="Use this endpoint"'
        )
        return response

Step_4_Update_Migration_Guide (30min):
  æª”æ¡ˆ: CLIENT_MIGRATION_GUIDE.md

  æ–°å¢ç« ç¯€:
    ## Migration Timeline

    - v1.1.0 (2025-01-13): Legacy endpoint marked DEPRECATED
    - v1.2.0 (2025-02-28): Usage monitoring & warnings added
    - v1.3.0 (2025-03-31): Deprecation headers added
    - v2.0.0 (2025-06-01): Legacy endpoint removed

    ## Breaking Changes in v2.0.0

    âŒ REMOVED: GET /api/v1/reports/search?limit=50
    âœ… USE: GET /api/v1/reports/search/paginated?page=1&page_size=50
```

### Git Workflow

```yaml
Branch: feat/debt-001-legacy-endpoint-monitoring
Commits:
  1. "feat: Add usage monitoring for legacy search endpoint"
  2. "feat: Add legacy endpoint statistics command"
  3. "feat: Add deprecation headers to legacy endpoint"
  4. "docs: Update migration guide with timeline"

PR_Title: "feat: Add legacy endpoint monitoring and migration timeline (DEBT-001)"
PR_Labels: [monitoring, deprecation, technical-debt]
```

### æ™‚é–“ä¼°ç®—

```
Usage monitoring:        2.0 å°æ™‚
Dashboard command:       1.0 å°æ™‚
Deprecation headers:     0.5 å°æ™‚
Migration guide:         0.5 å°æ™‚
æ¸¬è©¦:                     0.5 å°æ™‚
Review & PR:             0.5 å°æ™‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½è¨ˆ:                    5.0 å°æ™‚
```

### æˆåŠŸæ¨™æº–

- âœ… Legacy endpoint ä½¿ç”¨é‡ç›£æ§æ­£å¸¸
- âœ… Dashboard command å¯æ­£å¸¸åŸ·è¡Œ
- âœ… Deprecation headers æ­£ç¢ºè¿”å›
- âœ… Migration guide æ›´æ–°å®Œæ•´
- âœ… PR åˆä½µè‡³ master

---

## 7. DEBT-002: Export é™åˆ¶æå‡ (v1.3.0)

### å•é¡Œé™³è¿°

**Current State**:
- Export é™åˆ¶ 10,000 ç­†è¨˜éŒ„
- å¤§å‹è³‡æ–™é›†ç„¡æ³•å®Œæ•´åŒ¯å‡º
- ç¼ºå°‘æ‰¹æ¬¡åŒ¯å‡ºæ©Ÿåˆ¶

**Target State**:
- æ”¯æ´å¤§å‹è³‡æ–™é›†åŒ¯å‡º (100K+ records)
- èƒŒæ™¯ä»»å‹™è™•ç†
- åˆ†æ‰¹åŒ¯å‡ºèˆ‡é€²åº¦è¿½è¹¤

### å¯¦ä½œæ¦‚è¦ (è©³ç´°è¦åŠƒåœ¨ v1.3.0)

```yaml
Architecture:
  - Celery background tasks
  - Chunked export (10K records per chunk)
  - S3/File storage for large exports
  - Progress tracking & notifications

Implementation:
  - studies/tasks.py: Celery tasks
  - studies/export_service.py: Chunked export logic
  - API endpoint: POST /exports/create (async)
  - API endpoint: GET /exports/{id}/status

æ™‚é–“ä¼°ç®—: 24 å°æ™‚
ç›®æ¨™ç‰ˆæœ¬: v1.3.0
```

---

## 8. DEBT-006: è¼¸å…¥é©—è­‰è£œå¼· (v1.3.0)

### å•é¡Œé™³è¿°

**Current State**:
- éƒ¨åˆ†ç«¯é»ç¼ºå°‘å®Œæ•´è¼¸å…¥é©—è­‰
- Pydantic validation ä¸å®Œæ•´
- å®‰å…¨é¢¨éšª (SQL injection, XSS)

**Target State**:
- æ‰€æœ‰ç«¯é»å®Œæ•´ input validation
- Custom Pydantic validators
- Security scanning é€šé

### å¯¦ä½œæ¦‚è¦ (è©³ç´°è¦åŠƒåœ¨ v1.3.0)

```yaml
Validation_Areas:
  - Date format validation (ISO 8601)
  - Enum validation (report_type, status)
  - String length limits
  - Special character sanitization
  - SQL injection prevention

Implementation:
  - studies/schemas.py: Custom validators
  - studies/validators.py: Reusable validation functions
  - Security tests

æ™‚é–“ä¼°ç®—: 16 å°æ™‚
ç›®æ¨™ç‰ˆæœ¬: v1.3.0
```

---

## 9. Git Workflow ç­–ç•¥

### Branch Naming Convention

```yaml
Format: <type>/debt-<number>-<short-description>

Examples:
  - docs/debt-003-tokenblacklist-documentation
  - refactor/debt-004-unified-pagination
  - refactor/debt-005-unified-error-handling
  - feat/debt-001-legacy-endpoint-monitoring
  - feat/debt-002-chunked-export
  - feat/debt-006-input-validation
```

### Commit Message Format

```yaml
Format: <type>(<scope>): <subject>

Types:
  - feat: æ–°åŠŸèƒ½
  - refactor: é‡æ§‹ (ä¸æ”¹è®Šè¡Œç‚º)
  - docs: æ–‡ä»¶
  - test: æ¸¬è©¦
  - chore: é›œé … (build, CI)

Examples:
  - "docs(auth): Add TokenBlackList mechanism documentation"
  - "refactor(pagination): Create BasePagination class"
  - "refactor(errors): Update report_api error handling"
  - "feat(monitoring): Add legacy endpoint usage tracking"
  - "test(pagination): Add BasePagination unit tests"
```

### PR Template

```markdown
## DEBT-XXX: [Title]

### Problem
[æè¿°è¦è§£æ±ºçš„æŠ€è¡“å‚µå‹™]

### Solution
[å¯¦ä½œæ–¹æ¡ˆèªªæ˜]

### Changes
- [ ] Feature/Refactoring implemented
- [ ] Tests added (unit + integration)
- [ ] Documentation updated
- [ ] Backward compatibility verified
- [ ] Performance benchmarks (if applicable)

### Testing
- Unit tests: X added
- Integration tests: Y added
- Coverage: Z%

### Risks
[æ½›åœ¨é¢¨éšªèˆ‡ç·©è§£ç­–ç•¥]

### Checklist
- [ ] Code review completed
- [ ] All tests pass
- [ ] Documentation complete
- [ ] No regressions
- [ ] Ready for merge

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
```

### Merge Strategy

```yaml
Merge_Type: Squash merge (preserve detailed commit history in PR)

Squash_Commit_Message:
  Format:
    <type>: <PR title> (#PR-number)

    <PR body summary>

    ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Example:
  refactor: Unify pagination logic with BasePagination (#12)

  - Created BasePagination class with shared logic
  - Refactored ReportPagination, StudyPagination, ProjectPagination
  - Added comprehensive pagination tests
  - Removed code duplication (DRY principle)

  Time saved: ~100 LOC removed
  Test coverage: 95%

  ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
```

### Branch Protection Rules

```yaml
Required_Checks:
  - All tests pass
  - Code coverage â‰¥ 90%
  - No linting errors
  - Documentation updated

Required_Reviews: 1 approver

Merge_Requirements:
  - All conversations resolved
  - CI pipeline green
  - No merge conflicts
```

---

## 10. æ¸¬è©¦ç­–ç•¥

### æ¸¬è©¦é‡‘å­—å¡”

```
        /\
       /  \        E2E Tests (5%)
      /â”€â”€â”€â”€\       - Full user scenarios
     /      \      - Critical paths
    /â”€â”€â”€â”€â”€â”€â”€â”€\     Integration Tests (25%)
   /          \    - API endpoint tests
  /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\   - Service layer tests
 /              \
/â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ Unit Tests (70%)
                   - Business logic
                   - Utilities
                   - Validators
```

### æ¸¬è©¦é¡åˆ¥

```yaml
Unit_Tests (70%):
  ç›®æ¨™è¦†è“‹ç‡: â‰¥95%

  ç¯„åœ:
    - BasePagination class methods
    - Exception classes
    - Error formatting functions
    - Validation logic
    - Service layer utilities

  å·¥å…·:
    - pytest
    - pytest-django
    - pytest-cov

Integration_Tests (25%):
  ç›®æ¨™è¦†è“‹ç‡: â‰¥90%

  ç¯„åœ:
    - API endpoints (report_api.py)
    - Database queries
    - Cache interactions
    - Service layer operations

  å·¥å…·:
    - Django TestCase
    - APIClient
    - Mock databases

E2E_Tests (5%):
  ç›®æ¨™è¦†è“‹ç‡: Critical paths

  ç¯„åœ:
    - Report search â†’ detail â†’ versions flow
    - Error handling scenarios
    - Pagination edge cases

  å·¥å…·:
    - pytest + requests
    - Playwright (if needed)

Performance_Tests:
  ç¯„åœ:
    - Pagination performance (1K, 10K, 100K records)
    - Error handling overhead
    - Cache hit rates

  å·¥å…·:
    - pytest-benchmark
    - django-debug-toolbar
    - SQL profiling
```

### æ¸¬è©¦åŸ·è¡Œç­–ç•¥

```yaml
Local_Development:
  command: pytest tests/ -v --cov=studies --cov-report=html
  before_commit: pytest tests/unit tests/integration -v

CI_Pipeline:
  on_push:
    - pytest tests/unit --cov=studies --cov-fail-under=95

  on_pr:
    - pytest tests/ --cov=studies --cov-fail-under=90
    - pytest tests/integration -v
    - Performance regression tests

  nightly:
    - Full test suite
    - Performance benchmarks
    - Security scans

Test_Data_Management:
  fixtures: tests/fixtures/
  factories: tests/factories.py
  cleanup: pytest --create-db --reuse-db=false
```

### æ¸¬è©¦æ–‡ä»¶çµ„ç¹”

```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ test_base_pagination.py
â”‚   â”œâ”€â”€ test_report_exceptions.py
â”‚   â””â”€â”€ test_error_formatting.py
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ test_report_api.py
â”‚   â”œâ”€â”€ test_pagination_integration.py
â”‚   â””â”€â”€ test_error_handling.py
â”œâ”€â”€ e2e/
â”‚   â””â”€â”€ test_report_workflows.py
â”œâ”€â”€ fixtures/
â”‚   â”œâ”€â”€ reports.json
â”‚   â””â”€â”€ users.json
â”œâ”€â”€ factories.py
â””â”€â”€ conftest.py
```

---

## 11. é¢¨éšªè©•ä¼°èˆ‡ç·©è§£

### é«˜é¢¨éšªé …ç›®

```yaml
RISK_HIGH_001_Backward_Compatibility:
  å‚µå‹™: DEBT-004 (Pagination), DEBT-005 (Error Handling)
  æ©Ÿç‡: MEDIUM (30%)
  å½±éŸ¿: CRITICAL (API å®¢æˆ¶ç«¯ä¸­æ–·)

  ç·©è§£ç­–ç•¥:
    1. å®Œæ•´çš„ backward compatibility tests
    2. API response format åš´æ ¼é©—è­‰
    3. Staging ç’°å¢ƒå®Œæ•´æ¸¬è©¦ (7 days)
    4. Gradual rollout (canary deployment)
    5. Rollback plan æº–å‚™

  å›æ»¾è¨ˆç•«:
    - Git revert commit
    - Database migration rollback
    - API version rollback
    - å®¢æˆ¶ç«¯é€šçŸ¥

RISK_HIGH_002_Performance_Degradation:
  å‚µå‹™: DEBT-004 (Pagination refactoring)
  æ©Ÿç‡: LOW (15%)
  å½±éŸ¿: HIGH (ç”¨æˆ¶é«”é©—ä¸‹é™)

  ç·©è§£ç­–ç•¥:
    1. æ•ˆèƒ½åŸºæº–æ¸¬è©¦ (before/after)
    2. SQL query profiling
    3. Load testing (10K concurrent users)
    4. Database index é©—è­‰
    5. Caching ç­–ç•¥æª¢æŸ¥

  ç›£æ§æŒ‡æ¨™:
    - API response time P95 < 200ms
    - Database query time < 50ms
    - Cache hit rate > 80%

RISK_HIGH_003_Production_Errors:
  å‚µå‹™: DEBT-005 (Error handling changes)
  æ©Ÿç‡: MEDIUM (25%)
  å½±éŸ¿: HIGH (éŒ¯èª¤è™•ç†å¤±æ•—)

  ç·©è§£ç­–ç•¥:
    1. Exception handling å®Œæ•´æ¸¬è©¦
    2. Error logging é©—è­‰
    3. Sentry integration æ¸¬è©¦
    4. Error response format é©—è­‰
    5. Graceful degradation æ¸¬è©¦

  ç›£æ§:
    - Error rate < 0.1%
    - Exception logging 100% coverage
    - Sentry notifications æ­£å¸¸
```

### ä¸­é¢¨éšªé …ç›®

```yaml
RISK_MEDIUM_001_Testing_Coverage:
  æ©Ÿç‡: MEDIUM (30%)
  å½±éŸ¿: MEDIUM (æ½›åœ¨ bugs)

  ç·©è§£:
    - Enforce 90%+ test coverage
    - Code review focus on tests
    - Edge case identification

RISK_MEDIUM_002_Documentation_Gaps:
  æ©Ÿç‡: LOW (20%)
  å½±éŸ¿: MEDIUM (ç¶­è­·å›°é›£)

  ç·©è§£:
    - Documentation review checklist
    - Code comments requirements
    - API documentation automation

RISK_MEDIUM_003_Timeline_Delays:
  æ©Ÿç‡: MEDIUM (35%)
  å½±éŸ¿: MEDIUM (å»¶é²ç™¼å¸ƒ)

  ç·©è§£:
    - Buffer time (20%) in estimates
    - Weekly progress review
    - Parallel work where possible
```

### é¢¨éšªçŸ©é™£

```
           IMPACT
        â”‚ LOW â”‚ MED â”‚ HIGH â”‚ CRIT â”‚
    â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
    HIGHâ”‚     â”‚ R2  â”‚      â”‚      â”‚
        â”‚     â”‚     â”‚      â”‚      â”‚
    MED â”‚     â”‚ R3  â”‚ R1   â”‚ R_H1 â”‚
        â”‚     â”‚     â”‚      â”‚      â”‚
    LOW â”‚     â”‚ R4  â”‚ R_H2 â”‚      â”‚
        â”‚     â”‚     â”‚      â”‚      â”‚
  PROB  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

Legend:
  R_H1: Backward Compatibility Risk
  R_H2: Performance Degradation Risk
  R1:   Production Errors Risk
  R2:   Testing Coverage Risk
  R3:   Timeline Delays Risk
  R4:   Documentation Gaps Risk
```

---

## 12. å®Œæˆæª¢æŸ¥æ¸…å–®

### DEBT-003: TokenBlackList æ–‡ä»¶åŒ–

```yaml
Documentation:
  - [ ] docs/authentication/token-blacklist.md å»ºç«‹
  - [ ] æ©Ÿåˆ¶èªªæ˜å®Œæ•´
  - [ ] æ¸…ç†ç­–ç•¥å®šç¾©
  - [ ] ç›£æ§å»ºè­°æä¾›

Implementation:
  - [ ] Cleanup management command å¯¦ä½œ
  - [ ] Dry-run mode åŠŸèƒ½æ­£å¸¸
  - [ ] Cron job é…ç½®

Testing:
  - [ ] Management command æ¸¬è©¦é€šé
  - [ ] Cleanup logic é©—è­‰
  - [ ] Documentation review å®Œæˆ

Deployment:
  - [ ] PR merged to master
  - [ ] Cron job scheduled
  - [ ] Monitoring alerts configured
```

### DEBT-004: Pagination é‚è¼¯é‡æ§‹

```yaml
Implementation:
  - [ ] BasePagination class å¯¦ä½œå®Œæˆ
  - [ ] ReportPagination é‡æ§‹å®Œæˆ
  - [ ] StudyPagination é‡æ§‹å®Œæˆ
  - [ ] ProjectPagination é‡æ§‹å®Œæˆ
  - [ ] Code duplication ç§»é™¤ (verify DRY)

Testing:
  - [ ] Unit tests â‰¥95% coverage
  - [ ] Integration tests pass
  - [ ] Backward compatibility verified
  - [ ] Performance benchmarks pass (no regression)

Documentation:
  - [ ] Code comments complete
  - [ ] API documentation updated
  - [ ] Migration notes added

Deployment:
  - [ ] PR merged to master
  - [ ] Staging deployment successful
  - [ ] Production deployment successful
  - [ ] Monitoring confirms no issues
```

### DEBT-005: éŒ¯èª¤è™•ç†çµ±ä¸€åŒ–

```yaml
Implementation:
  - [ ] Report exception classes added
  - [ ] Error handler middleware created
  - [ ] report_api error handling refactored
  - [ ] report_service error handling refactored
  - [ ] HTTP status mapping implemented

Testing:
  - [ ] Exception tests â‰¥90% coverage
  - [ ] Error format tests pass
  - [ ] Integration tests verify error responses
  - [ ] E2E error scenarios tested

Documentation:
  - [ ] docs/api/error-handling.md created
  - [ ] Error codes documented
  - [ ] Client examples provided

Deployment:
  - [ ] PR merged to master
  - [ ] Error monitoring configured (Sentry)
  - [ ] Request ID tracking verified
```

### DEBT-001: Legacy Endpoint ç›£æ§

```yaml
Implementation:
  - [ ] Usage monitoring added
  - [ ] Statistics command created
  - [ ] Deprecation headers added
  - [ ] Migration guide updated

Testing:
  - [ ] Monitoring logic tested
  - [ ] Dashboard command works
  - [ ] Headers verification

Deployment:
  - [ ] PR merged to master
  - [ ] Monitoring dashboard accessible
  - [ ] Client notifications sent
```

### æ•´é«”å®Œæˆæ¨™æº–

```yaml
Code_Quality:
  - [ ] æ‰€æœ‰ PRs merged
  - [ ] No regressions detected
  - [ ] Test coverage â‰¥90%
  - [ ] Code review approved

Documentation:
  - [ ] All technical docs complete
  - [ ] API documentation updated
  - [ ] Migration guides provided

Deployment:
  - [ ] Staging tests passed
  - [ ] Production deployment successful
  - [ ] Monitoring shows normal metrics
  - [ ] No critical errors

Verification:
  - [ ] Performance benchmarks met
  - [ ] Backward compatibility verified
  - [ ] Security scan passed
  - [ ] Client feedback positive
```

---

## ğŸ“Š ç¸½çµ

### åŸ·è¡Œæ™‚ç¨‹

```
Week 1:   DEBT-003 (3h) âœ“
Week 2:   DEBT-004 (11h) â†’ BasePagination refactor
Week 3:   DEBT-005 (15h) â†’ Error handling unification
Week 4:   DEBT-001 (5h) â†’ Legacy endpoint monitoring
Month 2:  DEBT-002 (24h) â†’ Export enhancement
Month 3:  DEBT-006 (16h) â†’ Input validation

Total:    74 hours over 12 weeks
```

### é æœŸæˆæœ

**v1.2.0 Release**:
- âœ… TokenBlackList å®Œæ•´æ–‡ä»¶èˆ‡è‡ªå‹•åŒ–
- âœ… çµ±ä¸€çš„ Pagination é‚è¼¯ (DRY)
- âœ… çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ ¼å¼
- âœ… Legacy endpoint ç›£æ§æ©Ÿåˆ¶

**v1.3.0 Release**:
- âœ… å¤§å‹è³‡æ–™é›†åŒ¯å‡ºæ”¯æ´
- âœ… å®Œæ•´çš„è¼¸å…¥é©—è­‰

**æŠ€è¡“å‚µå‹™æ¸›å°‘**: 6 items â†’ 0 items (100% æ¸…ç†)

### æˆåŠŸæŒ‡æ¨™

```
ç¨‹å¼ç¢¼å“è³ª:     A- â†’ A+
æŠ€è¡“å‚µå‹™:       6 items â†’ 0 items
æ¸¬è©¦è¦†è“‹ç‡:     85% â†’ 95%
ç¶­è­·æˆæœ¬:       â–¼ 40% reduction
API ä¸€è‡´æ€§:     70% â†’ 100%
```

---

**æ–‡ä»¶ç¶­è­·**: æœ¬å·¥ä½œæµç¨‹æ‡‰éš¨å¯¦ä½œé€²åº¦æ›´æ–°
**è² è²¬äºº**: Backend Development Team
**æœ€å¾Œæ›´æ–°**: 2025-01-13
**ä¸‹æ¬¡ Review**: æ¯é€±ä¸€ 10:00 AM

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
